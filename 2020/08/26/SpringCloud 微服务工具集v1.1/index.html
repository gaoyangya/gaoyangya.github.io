<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>Spring Cloud | gy的小站</title>

  <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://cdn.jsdelivr.net/gh/inkss/fontawesome@5.15.3/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
    <script>
        var themeModelId = '';
        if (themeModelId) {
            localStorage.setItem('modelId', themeModelId);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/gh/yuang01/live2d-widget@latest/autoload.js"></script>
    <script>
        var live2dOpen = eval('true') || false;
        if (!live2dOpen) {
            localStorage.setItem('waifu-display', 1609323474481);
        }
    </script>
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
    
<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    

    <!-- import link -->
    
        
            
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 5.4.2"></head>

  
  <!-- 依赖于jquery和vue -->
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

  

  
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"></script>

  
  
  <body>
    <!-- 预加载动画 -->
    <!-- 页面预加载动画 -->

<div id='loader'>
  <link rel="stylesheet" href="/js/loaded/index.css" >
  <div class="loading-left-bg"></div>
  <div class="loading-right-bg"></div>
  <div class="spinner-box">
    <div class="configure-border-1">
      <div class="configure-core"></div>
    </div>
    <div class="configure-border-2">
      <div class="configure-core"></div>
    </div>
    <div class="loading-word">加载中...</div>
  </div>
</div>

<script>
  var endLoading = function () {
    document.body.style.overflow = 'auto';
    document.getElementById('loader').classList.add("loading");
  }
  window.addEventListener('DOMContentLoaded',endLoading);
  
</script>

    
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (href, before, media, attributes) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header   " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo lazyload placeholder" src="/medias/logo.png" class="lazyload placeholder" data-srcset="/medias/logo.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="logo">
      <h3 class="drawer-box-head_title">gy的小站</h3>
      <h5 class="drawer-box-head_desc">滴水穿石不是水的力量,而是坚持的力量</h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">分类</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/about" class="drawer-menu-item-link">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/friends" class="drawer-menu-item-link">
                  
                  <span class="name">友情链接</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="javascript:;" class="drawer-menu-item-link has-children" @click="openOrCloseMenu(6)">
                  <span>
                    
                      <i class="fas fa-link"></i>
                    
                    <span class="name">更多</span>
                  </span>
                  <i class="fas fa-chevron-left arrow " :class="{'icon-rotate': isOpen(6)}" aria-hidden="true"></i>
                </a>
                <ul class="drawer-sub-menu" v-if="isOpen(6)">
                  
                  <li>
                    <a href="/gallery">
                      
                      <i class="fas fa-music" style="margin-top: -20px;"></i>
                      
                      <span>工大风光</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/huoban">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>资源推荐</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/me">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>考研与就业</span>
                    </a>
                  </li>
                  
                  <li>
                    <a target="_blank" rel="noopener" href="http://baidu.com">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>百度</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
        
          <li class="drawer-box-content_item">
            <a target="_blank" rel="noopener" href="https://github.com/gaoyangya">
              <i class="fas fa-github" aria-hidden="true"></i>
              <span>Github</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="/medias/logo.png" class="lazyload placeholder" data-srcset="/medias/logo.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="logo">
        </div>
      
      <a href="/" class="logo">gy的小站</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="首页">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="归档">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="标签">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="分类">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">分类</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/about" class="menu-item-link" title="关于">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/friends" class="menu-item-link" title="友情链接">
                  
                  <span class="name">友情链接</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="javascript:;" class="menu-item-link" title="更多">
                  
                    <i class="fas fa-link"></i>
                  
                  <span class="name">更多</span>
                  <i class="fas fa-chevron-down arrow" aria-hidden="true"></i>
                </a>
                <ul class="sub-menu">
                  
                  <li>
                    <a href="/gallery">
                      
                      <i class="fas fa-music" style="margin-top: -20px;"></i>
                      
                      <span>工大风光</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/huoban">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>资源推荐</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/me">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>考研与就业</span>
                    </a>
                  </li>
                  
                  <li>
                    <a target="_blank" rel="noopener" href="http://baidu.com">
                      
                      <i class="fas fa-film" style="margin-top: -20px;"></i>
                      
                      <span>百度</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">本地搜索</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="请输入关键字"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
    <a target="_blank" rel="noopener" href="https://github.com/gaoyangya" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
  
    <div id="he-plugin-simple"></div>
    <script>
      WIDGET = {
        CONFIG: {
          "modules": "012",
          "background": 5,
          "tmpColor": "4A4A4A",
          "tmpSize": 16,
          "cityColor": "4A4A4A",
          "citySize": 16,
          "aqiSize": 16,
          "weatherIconSize": 24,
          "alertIconSize": 18,
          "padding": "10px 10px 10px 10px",
          "shadow": "1",
          "language": "auto",
          "borderRadius": 5,
          "fixed": "false",
          "vertical": "middle",
          "horizontal": "center",
          "key": "2784dd3fcb1e4f0f9a9b579bf69641f2"
        }
      }
    </script>
    <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script> 
    
</header>
        <!-- 内容区域 -->
        
 <!-- prismjs 代码高亮 -->
 
    
    <link href="/js/prism/prism-line-numbers.css" rel="stylesheet">
    
        <link href="/js/prism/prism.min.css" rel="stylesheet">
    

    <style>
        pre[class*="language-"] {
            overflow-y: hidden;
        }
        .line-numbers .line-numbers-rows {
            border: none;
        }
    </style>
  


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('/medias/11.jpg')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        Spring Cloud
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> 发表于：2020-08-26 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> 分类：
          
            <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-detail-header_category">
              微服务
            </a>
          
        </span>
      

      
    
  </div>
  
  
    <script src="/js/bubble/bubble.js"></script>
  
</div>





<div class="row justify-position" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <h2 id="Spring-Cloud-微服务工具集v1-1"><a href="#Spring-Cloud-微服务工具集v1-1" class="headerlink" title="Spring Cloud 微服务工具集v1.1"></a>Spring Cloud 微服务工具集v1.1</h2><ul>
<li><strong>版本: Hoxton SR6</strong></li>
</ul>
<h2 id="1-什么是微服务"><a href="#1-什么是微服务" class="headerlink" title="1.什么是微服务"></a>1.什么是微服务</h2><ul>
<li>官网: <a target="_blank" rel="noopener" href="https://www.martinfowler.com/articles/microservices.html">https://www.martinfowler.com/articles/microservices.html</a></li>
</ul>
<p>In short, the microservice architectural(架构) style is an approach to developing a single application as <code>a suite(系列) of small services</code>, each <code>running in its own process(进程)</code> and communicating with lightweight mechanisms, often an HTTP resource API. These services are <code>built around business(业务) capabilities(单元)</code> and <code>independently(独立) deployable(部署)</code> by fully automated deployment machinery. <code>There is a bare(基于) minimum of centralized(分布式) management(管理) of these services</code>, which may be written in different programming languages and use different data storage technologies.                        —–[摘自官网]</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token operator">-</span> a suite of small services                      				<span class="token operator">--</span>一系列微小服务
<span class="token operator">-</span> running <span class="token keyword">in</span> its own process                                    <span class="token operator">--</span>运行在自己的进程里
<span class="token operator">-</span> built around business capabilities                            <span class="token operator">--</span>围绕自己的业务开发
<span class="token operator">-</span> independently deployable                                      <span class="token operator">--</span>独立部署
<span class="token operator">-</span> bare minimum of centralized management of these services      <span class="token operator">--</span>基于分布式管理<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>官方定义:<strong>微服务就是由一系列围绕自己业务开发的微小服务构成,他们独立部署运行在自己的进程里,基于分布式的管理</strong></li>
<li>通俗定义:<strong>微服务是一种架构，这种架构是将单个的整体应用程序分割成更小的项目关联的独立的服务。一个服务通常实现一组独立的特性或功能，包含自己的业务逻辑和适配器。各个微服务之间的关联通过暴露api来实现。这些独立的微服务不需要部署在同一个虚拟机，同一个系统和同一个应用服务器中。</strong></li>
</ul>
<hr>
<h2 id="2-为什么是微服务"><a href="#2-为什么是微服务" class="headerlink" title="2.为什么是微服务?"></a>2.为什么是微服务?</h2><h3 id="单体应用"><a href="#单体应用" class="headerlink" title="单体应用"></a>单体应用</h3><p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542615.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542615.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200708224716035"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>优点
<span class="token operator">-</span>	单一架构模式在项目初期很小的时候开发方便，测试方便，部署方便，运行良好。
# <span class="token number">2</span><span class="token punctuation">.</span>缺点
<span class="token operator">-</span> 应用随着时间的推进，加入的功能越来越多，最终会变得巨大，一个项目中很有可能数百万行的代码，互相之间繁琐的jar包。
<span class="token operator">-</span> 久而久之，开发效率低，代码维护困难
<span class="token operator">-</span> 还有一个如果想整体应用采用新的技术，新的框架或者语言，那是不可能的。
<span class="token operator">-</span> 任意模块的漏洞或者错误都会影响这个应用，降低系统的可靠性<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="微服务架构应用"><a href="#微服务架构应用" class="headerlink" title="微服务架构应用"></a>微服务架构应用</h3><p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542483.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542483.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723155352063"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>优点
<span class="token operator">-</span> 将服务拆分成多个单一职责的小的服务，进行单独部署，服务之间通过网络进行通信
<span class="token operator">-</span> 每个服务应该有自己单独的管理团队，高度自治
<span class="token operator">-</span> 服务各自有自己单独的职责，服务之间松耦合，避免因一个模块的问题导致服务崩溃
# <span class="token number">2</span><span class="token punctuation">.</span>缺点
<span class="token operator">-</span> 开发人员要处理分布式系统的复杂性
<span class="token operator">-</span> 多服务运维难度，随着服务的增加，运维的压力也在增大
<span class="token operator">-</span> 服务治理 和 服务监控 关键<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="架构的演变"><a href="#架构的演变" class="headerlink" title="架构的演变"></a>架构的演变</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>架构的演变过程
<span class="token operator">-</span> <span class="token punctuation">[</span>单一应用架构<span class="token punctuation">]</span> `<span class="token operator">===</span><span class="token operator">></span>` <span class="token punctuation">[</span>垂直应用架构<span class="token punctuation">]</span> `<span class="token operator">===</span><span class="token operator">></span>` <span class="token punctuation">[</span>分布式服务架构<span class="token punctuation">]</span> `<span class="token operator">===</span><span class="token operator">></span>` <span class="token punctuation">[</span>流动计算架构<span class="token punctuation">]</span><span class="token operator">||</span><span class="token punctuation">[</span>微服务架构<span class="token punctuation">]</span> `<span class="token operator">===</span><span class="token operator">></span>` <span class="token punctuation">[</span>未知<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>dubbo官网:<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/preface/background.html">http://dubbo.apache.org/zh-cn/docs/user/preface/background.html</a></li>
</ul>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542099.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542099.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200318082336122"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span> All <span class="token keyword">in</span> One Application 	单一架构
<span class="token operator">-</span> 起初当网站流量很小时<span class="token punctuation">,</span>将所有功能都写在一个应用里面<span class="token punctuation">,</span>对整个应用进行部署<span class="token punctuation">,</span>以减少部署节点和成本。对于这个架构简化增删改查的工作量的数据访问框架（ORM）是关键。

# <span class="token number">2</span><span class="token punctuation">.</span> Vertical Application 		垂直架构
<span class="token operator">-</span> 当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，提升效率的方法之一是将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架<span class="token punctuation">(</span>MVC<span class="token punctuation">)</span>是关键。

# <span class="token number">3</span><span class="token punctuation">.</span> Distributed Service    	分布式服务架构
<span class="token operator">-</span> 当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架<span class="token punctuation">(</span>RPC<span class="token punctuation">)</span>是关键。

# <span class="token number">4</span><span class="token punctuation">.</span> Elastic Computing				流动计算架构即微服务架构
<span class="token operator">-</span> 当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心<span class="token punctuation">(</span>SOA<span class="token punctuation">)</span>是关键<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>友情提醒: <strong>好的架构并不是设计出来的,一定是进化来的!!!</strong></li>
</ul>
<hr>
<h2 id="3-微服务的解决方案"><a href="#3-微服务的解决方案" class="headerlink" title="3.微服务的解决方案"></a>3.微服务的解决方案</h2><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span><span class="token function">Dubbo</span> <span class="token punctuation">(</span>阿里系<span class="token punctuation">)</span>
<span class="token operator">-</span> 初出茅庐<span class="token operator">:</span><span class="token number">2011</span>年末，阿里巴巴在GitHub上开源了基于Java的分布式服务治理框架Dubbo，之后它成为了国内该类开源项目的佼佼者，许多开发者对其表示青睐。同时，先后有不少公司在实践中基于Dubbo进行分布式系统架构，目前在GitHub上，它的fork、star数均已破万。Dubbo致力于提供高性能和透明化的RPC远程服务调用方案，以及SOA服务治理方案，使得应用可通过高性能RPC实现服务的输出、输入功能和Spring框架无缝集成。Dubbo包含远程通讯、集群容错和自动发现三个核心部分。

<span class="token operator">-</span> 停止维护<span class="token operator">:</span>从<span class="token number">2012</span>年<span class="token number">10</span>月<span class="token number">23</span>日Dubbo <span class="token number">2.5</span><span class="token punctuation">.</span><span class="token number">3</span>发布后，在Dubbo开源将满一周年之际，阿里基本停止了对Dubbo的主要升级。只在之后的<span class="token number">2013</span>年和<span class="token number">2014</span>年更新过<span class="token number">2</span>次对Dubbo <span class="token number">2.4</span>的维护版本，然后停止了所有维护工作。Dubbo对Srping的支持也停留在了Spring <span class="token number">2.5</span><span class="token punctuation">.</span><span class="token number">6</span>版本上。

<span class="token operator">-</span> 死而复生<span class="token operator">:</span>多年漫长的等待，随着微服务的火热兴起，在国内外开发者对阿里不再升级维护Dubbo的吐槽声中，阿里终于开始重新对Dubbo的升级和维护工作。在<span class="token number">2017</span>年<span class="token number">9</span>月<span class="token number">7</span>日，阿里发布了Dubbo的<span class="token number">2.5</span><span class="token punctuation">.</span><span class="token number">4</span>版本，距离上一个版本<span class="token number">2.5</span><span class="token punctuation">.</span><span class="token number">3</span>发布已经接近快<span class="token number">5</span>年时间了。在随后的几个月中，阿里Dubbo开发团队以差不多每月一版本的速度开始快速升级迭代，修补了Dubbo老版本多年来存在的诸多bug，并对Spring等组件的支持进行了全面升级。

<span class="token operator">-</span> <span class="token number">2018</span>年<span class="token number">1</span>月<span class="token number">8</span>日，Dubbo创始人之一梁飞在Dubbo交流群里透露了Dubbo <span class="token number">3.0</span>正在动工的消息。Dubbo <span class="token number">3.0</span>内核与Dubbo <span class="token number">2.0</span>完全不同，但兼容Dubbo <span class="token number">2.0</span>。Dubbo <span class="token number">3.0</span>将以Streaming为内核，不再是Dubbo 时代的RPC，但是RPC会在Dubbo <span class="token number">3.0</span>中变成远程Streaming对接的一种可选形态。从Dubbo新版本的路线规划上可以看出，新版本的Dubbo在原有服务治理的功能基础上，将全面拥抱微服务解决方案。

<span class="token operator">-</span> 结论<span class="token operator">:</span>当前由于RPC协议、注册中心元数据不匹配等问题，在面临微服务基础框架选型时Dubbo与Spring Cloud是只能二选一，这也是为什么大家总是拿Dubbo和Spring Cloud做对比的原因之一。Dubbo之后会积极寻求适配到Spring Cloud生态，比如作为Spring Cloud的二进制通信方案来发挥Dubbo的性能优势，或者Dubbo通过模块化以及对http的支持适配到Spring Cloud。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542369.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542369.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200724143456045"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># Spring Cloud<span class="token operator">:</span>
<span class="token operator">-</span> Spring Cloud NetFlix  
	基于美国Netflix公司开源的组件进行封装<span class="token punctuation">,</span>提供了微服务一栈式的解决方案。

<span class="token operator">-</span> Spring Cloud alibaba
	在Spring cloud netflix基础上封装了阿里巴巴的微服务解决方案。
	
<span class="token operator">-</span> Spring Cloud Spring
	目前spring官方趋势正在逐渐吸收Netflix组件的精华<span class="token punctuation">,</span>并在此基础进行二次封装优化<span class="token punctuation">,</span>打造spring专有的解决方案<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-什么是SpringCloud"><a href="#4-什么是SpringCloud" class="headerlink" title="4.什么是SpringCloud"></a>4.什么是SpringCloud</h2><h3 id="官方定义"><a href="#官方定义" class="headerlink" title="官方定义"></a>官方定义</h3><ul>
<li>官方网址: <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR5/reference/html/">https://cloud.spring.io/spring-cloud-static/Hoxton.SR5/reference/html/</a></li>
</ul>
<p><strong>Spring Cloud provides tools for developers to quickly build some of the common patterns in distributed systems</strong> (e.g. <code>configuration management</code>,<code> service discovery</code>, <code>circuit breakers, intelligent routing, micro-proxy, control bus</code>). Coordination of distributed systems leads to boiler plate patterns, and using Spring Cloud developers can quickly stand up services and applications that implement those patterns.  ——-[摘自官网]</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>翻译
<span class="token operator">-</span> springcloud为开发人员提供了在分布式系统中快速构建一些通用模式的工具（例如配置管理、服务发现、断路器、智能路由、微代理、控制总线）。分布式系统的协调导致了锅炉板模式，使用springcloud开发人员可以快速地建立实现这些模式的服务和应用程序。

# <span class="token number">2</span><span class="token punctuation">.</span>通俗理解
<span class="token operator">-</span> springcloud是一个含概多个子项目的开发工具集<span class="token punctuation">,</span>集合了众多的开源框架<span class="token punctuation">,</span>他利用了Spring Boot开发的便利性实现了很多功能<span class="token punctuation">,</span>如服务注册<span class="token punctuation">,</span>服务注册发现<span class="token punctuation">,</span>负载均衡等<span class="token punctuation">.</span>SpringCloud在整合过程中主要是针对<span class="token function">Netflix</span><span class="token punctuation">(</span>耐非<span class="token punctuation">)</span>开源组件的封装<span class="token punctuation">.</span>SpringCloud的出现真正的简化了分布式架构的开发。NetFlix 是美国的一个在线视频网站<span class="token punctuation">,</span>微服务业的翘楚<span class="token punctuation">,</span>他是公认的大规模生产级微服务的杰出实践者<span class="token punctuation">,</span>NetFlix的开源组件已经在他大规模分布式微服务环境中经过多年的生产实战验证<span class="token punctuation">,</span>因此Spring Cloud中很多组件都是基于NetFlix
spring netflix 维护  闭源<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="核心架构及其组件"><a href="#核心架构及其组件" class="headerlink" title="核心架构及其组件"></a>核心架构及其组件</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>核心组件说明
<span class="token operator">-</span> eurekaserver、consul、nacos  	 服务注册中心组件
<span class="token operator">-</span> rabbion &amp; openfeign  			  服务负载均衡 和 服务调用组件
<span class="token operator">-</span> hystrix &amp; hystrix dashboard     服务断路器  和  服务监控组件
<span class="token operator">-</span> zuul、gateway 					 服务网关组件
<span class="token operator">-</span> config 						  统一配置中心组件
<span class="token operator">-</span> bus                             消息总线组件
<span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542818.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542818.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200724161314786"></p>
<hr>
<h2 id="5-环境搭建"><a href="#5-环境搭建" class="headerlink" title="5.环境搭建"></a>5.环境搭建</h2><h3 id="版本命名"><a href="#版本命名" class="headerlink" title="版本命名"></a>版本命名</h3><ul>
<li>官网地址:<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></li>
</ul>
<p>Spring Cloud is an umbrella(伞) project consisting of independent projects with, in principle, different release cadences. To manage the portfolio a BOM (Bill of Materials) is published with a curated set of dependencies on the individual project (see below). The release trains have names, not versions, to avoid confusion with the sub-projects. The names are an alphabetic sequence (so you can sort them chronologically) with names of London Tube stations (“Angel” is the first release, “Brixton” is the second). When point releases of the individual projects accumulate to a critical mass, or if there is a critical bug in one of them that needs to be available to everyone, the release train will push out “service releases” with names ending “.SRX”, where “X” is a number.     —[摘自官网]</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>翻译
<span class="token operator">-</span> springcloud是一个由众多独立子项目组成的大型综合项目，原则每个子项目上有不同的发布节奏<span class="token punctuation">,</span>都维护自己发布版本号。为了更好的管理springcloud的版本<span class="token punctuation">,</span>通过一个资源清单<span class="token function">BOM</span><span class="token punctuation">(</span>Bill of Materials<span class="token punctuation">)</span><span class="token punctuation">,</span>为避免与子项目的发布号混淆，所以没有采用版本号的方式，而是通过命名的方式。这些名字是按字母顺序排列的。如伦敦地铁站的名称（“天使”是第一个版本，“布里斯顿”是第二个版本<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"卡姆登"</span></span>是第三个版本）。当单个项目的点发布累积到一个临界量，或者其中一个项目中有一个关键缺陷需要每个人都可以使用时，发布序列将推出名称以“<span class="token punctuation">.</span>SRX”结尾的“服务发布”，其中“X”是一个数字。

# <span class="token number">2</span><span class="token punctuation">.</span>伦敦地铁站名称 <span class="token punctuation">[</span>了解<span class="token punctuation">]</span>
<span class="token operator">-</span> Angel、Brixton、Camden、Dalston、Edgware、Finchley、Greenwich、Hoxton<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>版本选择官方建议 https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>projects<span class="token operator">/</span>spring<span class="token operator">-</span>cloud
<span class="token operator">-</span> Angel 										版本基于springboot1<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">.</span>x版本构建与<span class="token number">1.3</span>版本不兼容
<span class="token operator">-</span> Brixton										版本基于springboot1<span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">.</span>x版本构建与<span class="token number">1.2</span>版本不兼容
	`<span class="token number">2017</span>年Brixton <span class="token operator">and</span> Angel release官方宣布报废
<span class="token operator">-</span> Camden      							版本基于springboot1<span class="token punctuation">.</span><span class="token number">4</span><span class="token punctuation">.</span>x版本构建并在<span class="token number">1.5</span>版本通过测试
	`<span class="token number">2018</span>年Camden release官方宣布报废
<span class="token operator">-</span> Dalston、Edgware 				 版本基于springboot1<span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">.</span>x版本构建目前不能再springboot2<span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>x版本中使用
	`<span class="token function">Dalston</span><span class="token punctuation">(</span>达尔斯顿<span class="token punctuation">)</span>将于<span class="token number">2018</span>年<span class="token number">12</span>月官方宣布报废。Edgware将遵循Spring Boot <span class="token number">1.5</span><span class="token punctuation">.</span>x的生命周期结束。
<span class="token operator">-</span> Finchley 									版本基于springboot2<span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span>x版本进行构建<span class="token punctuation">,</span>不能兼容<span class="token number">1</span><span class="token punctuation">.</span>x版本
<span class="token operator">-</span> Greenwich									版本基于springboot2<span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">.</span>x版本进行构建<span class="token punctuation">,</span>不能兼容<span class="token number">1</span><span class="token punctuation">.</span>x版本
<span class="token operator">-</span> Hoxton									版本基于springboot2<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">.</span>x版本进行构建


Spring Cloud Dalston<span class="token punctuation">,</span> Edgware<span class="token punctuation">,</span> Finchley<span class="token punctuation">,</span> <span class="token operator">and</span> Greenwich have all reached end of life status <span class="token operator">and</span> are no longer supported<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542412.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542412.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709112427684"></p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> springboot <span class="token number">2.2</span><span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">.</span>RELEASE
<span class="token operator">-</span> springcloud Hoxton<span class="token punctuation">.</span>SR6
<span class="token operator">-</span> java8
<span class="token operator">-</span> maven <span class="token number">3.3</span><span class="token punctuation">.</span><span class="token number">9</span> 
<span class="token operator">-</span> idea <span class="token number">2018.3</span><span class="token punctuation">.</span><span class="token number">5</span>

# <span class="token number">1</span><span class="token punctuation">.</span>创建springboot项目 指定版本为 <span class="token number">2.2</span><span class="token punctuation">.</span><span class="token number">5</span>版本<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542928.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231542928.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709115802270"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>引入springcloud的版本管理<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--定义springcloud使用版本号--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">></span></span>Hoxton.SR6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--全局管理springcloud版本,并不会引入具体依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-cloud.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543633.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543633.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709120120478"></p>
<p>![image-20200709120209047](SpringCloud 微服务工具集v1.1.assets/image-20200709120209047.png)</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>完成上述操作springboot与springcloud环境搭建完成
<span class="token operator">-</span> 接下来就是使用到具体的springcloud组件<span class="token punctuation">,</span>在项目中引入具体的组件即可<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="6-服务注册中心"><a href="#6-服务注册中心" class="headerlink" title="6.服务注册中心"></a>6.服务注册中心</h2><h3 id="什么服务注册中心"><a href="#什么服务注册中心" class="headerlink" title="什么服务注册中心"></a>什么服务注册中心</h3><p>所谓服务注册中心就是在整个的微服务架构中单独提出一个服务，这个服务不完成系统的任何的业务功能，仅仅用来完成对整个微服务系统的服务注册和服务发现，以及对服务健康状态的监控和管理功能。</p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543080.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543080.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709124952525"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>服务注册中心
<span class="token operator">-</span> 可以对所有的微服务的信息进行存储，如微服务的名称、IP、端口等
<span class="token operator">-</span> 可以在进行服务调用时通过服务发现查询可用的微服务列表及网络地址进行服务调用
<span class="token operator">-</span> 可以对所有的微服务进行心跳检测，如发现某实例长时间无法访问，就会从服务注册表移除该实例。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="常用的注册中心"><a href="#常用的注册中心" class="headerlink" title="常用的注册中心"></a>常用的注册中心</h3><p>springcloud支持的多种注册中心Eureka、Consul、Zookeeper、以及阿里巴巴推出Nacos。这些注册中心在本质上都是用来管理服务的注册和发现以及服务状态的检查的。</p>
<h4 id="1-Eureka"><a href="#1-Eureka" class="headerlink" title="1.Eureka"></a>1.Eureka</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>简介
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>eureka<span class="token operator">/</span>wiki
<span class="token operator">-</span> Eureka是Netflix开发的服务发现框架，本身是一个基于REST的服务。SpringCloud将它集成在其子项目spring<span class="token operator">-</span>cloud<span class="token operator">-</span>netflix中，		以实现SpringCloud的服务注册和发现功能。
	Eureka包含两个组件：Eureka Server和Eureka Client。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="开发Eureka-Server"><a href="#开发Eureka-Server" class="headerlink" title="开发Eureka Server"></a>开发Eureka Server</h5><pre class="line-numbers language-none"><code class="language-none"># 1.创建项目并引入eureka server依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入 eureka server--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543157.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543157.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709160918779"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>编写配置application<span class="token punctuation">.</span>properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8761</span>																			#执行服务端口
spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>eurekaserver 									#指定服务名称 唯一标识
eureka<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token operator">-</span>url<span class="token punctuation">.</span>defaultZone<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8761</span><span class="token operator">/</span>eureka  #指定服务注册中心的地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none"># 3.开启Eureka Server,入口类加入注解<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Eurekaserver8761Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Eurekaserver8761Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543186.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543186.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709162043210"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>访问Eureka的服务注册页面
<span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8761</span><span class="token operator">/</span>eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543107.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543107.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709161916871"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>虽然能看到管理界面为什么项目启动控制台报错<span class="token operator">?</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543253.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543253.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709162307608"></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 出现上述问题原因:eureka组件包含 eurekaserver 和 eurekaclient。server是一个服务注册中心,用来接受客户端的注册。client的特性会让当前启动的服务把自己作为eureka的客户端进行服务中心的注册,当项目启动时服务注册中心还没有创建好,所以找我不到服务的客户端组件就直接报错了，当启动成功服务注册中心创建好了，日后client也能进行注册，就不再报错啦！<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>关闭Eureka自己注册自己<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8761</span>
spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>eurekaserver
eureka<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token operator">-</span>url<span class="token punctuation">.</span>defaultZone<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8761</span><span class="token operator">/</span>eureka
eureka<span class="token punctuation">.</span>client<span class="token punctuation">.</span>register<span class="token operator">-</span>with<span class="token operator">-</span>eureka<span class="token operator">=</span><span class="token boolean">false</span>    #不再将自己同时作为客户端进行注册  
eureka<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fetch<span class="token operator">-</span>registry<span class="token operator">=</span><span class="token boolean">false</span>				  #关闭作为客户端时从eureka server获取服务信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543390.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543390.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709163511121"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">7</span><span class="token punctuation">.</span>再次启动<span class="token punctuation">,</span>当前应用就是一个单纯Eureka Server<span class="token punctuation">,</span>控制器也不再报错<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543079.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543079.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709163630273"></p>
<h5 id="开发Eureka-Client"><a href="#开发Eureka-Client" class="headerlink" title="开发Eureka Client"></a>开发Eureka Client</h5><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>创建项目并引入eureka client依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入eureka client--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543432.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543432.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709164110003"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>编写配置application<span class="token punctuation">.</span>properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8888</span>																		#服务端口号
spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>eurekaclient8888						#服务名称唯一标识
eureka<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token operator">-</span>url<span class="token punctuation">.</span>defaultZone<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8761</span><span class="token operator">/</span>eureka #eureka注册中心地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543300.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231543300.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709164404396"></p>
<pre class="line-numbers language-none"><code class="language-none"># 3.开启eureka客户端加入注解<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Eurekaclient8888Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Eurekaclient8888Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544216.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544216.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709164505482"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>启动之前的<span class="token number">8761</span>的服务注册中心<span class="token punctuation">,</span>在启动eureka客户端服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544285.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544285.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709164622017"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>查看eureka server的服务注册情况<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544235.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544235.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709164729870"></p>
<h5 id="eureka自我保护机制"><a href="#eureka自我保护机制" class="headerlink" title="eureka自我保护机制"></a>eureka自我保护机制</h5><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>服务频繁启动时 EurekaServer出现错误
<span class="token operator">-</span> EMERGENCY<span class="token operator">!</span> EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY'RE NOT<span class="token punctuation">.</span> RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544510.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544510.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709171532408"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>自我保护机制
<span class="token operator">-</span> 官网地址<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>eureka<span class="token operator">/</span>wiki<span class="token operator">/</span>Server<span class="token operator">-</span>Self<span class="token operator">-</span>Preservation<span class="token operator">-</span>Mode
<span class="token operator">-</span> 默认情况下，如果Eureka Server在一定时间内（默认<span class="token number">90</span>秒）没有接收到某个微服务实例的心跳，Eureka Server将会移除该实例。但是当网络分区故障发生时，微服务与Eureka Server之间无法正常通信，而微服务本身是正常运行的，此时不应该移除这个微服务，所以引入了自我保护机制。Eureka Server在运行期间会去统计心跳失败比例在 <span class="token number">15</span> 分钟之内是否低于 <span class="token number">85</span><span class="token operator">%</span>，如果低于 <span class="token number">85</span><span class="token operator">%</span>，Eureka Server 会将这些实例保护起来，让这些实例不会过期。这种设计的哲学原理就是<span class="token string-literal singleline"><span class="token string">"宁可信其有不可信其无!"</span></span>。自我保护模式正是一种针对网络异常波动的安全保护措施，使用自我保护模式能使Eureka集群更加的健壮、稳定的运行。

# <span class="token number">2</span><span class="token punctuation">.</span>在eureka server端关闭自我保护机制<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">eureka.server.enable-self-preservation</span><span class="token punctuation">=</span><span class="token attr-value">false  #关闭自我保护</span>
<span class="token attr-name">eureka.server.eviction-interval-timer-in-ms</span><span class="token punctuation">=</span><span class="token attr-value">3000 #超时3s自动清除</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544215.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544215.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709231727148"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>微服务修改减短服务心跳的时间<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">eureka.instance.lease-expiration-duration-in-seconds</span><span class="token punctuation">=</span><span class="token attr-value">10 #用来修改eureka server默认接受心跳的最大时间 默认是90s</span>
<span class="token attr-name">eureka.instance.lease-renewal-interval-in-seconds</span><span class="token punctuation">=</span><span class="token attr-value">5     #指定客户端多久向eureka server发送一次心跳 默认是30s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>尽管如此关闭自我保护机制还是会出现警告
<span class="token operator">-</span> THE SELF PRESERVATION MODE IS TURNED OFF<span class="token punctuation">.</span> THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK<span class="token operator">/</span>OTHER PROBLEMS<span class="token punctuation">.</span>
<span class="token operator">-</span> `官方并不建议在生产情况下关闭<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544377.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544377.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709232933894"></p>
<h5 id="eureka-停止更新"><a href="#eureka-停止更新" class="headerlink" title="eureka 停止更新"></a>eureka 停止更新</h5><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>官方停止更新说明
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>eureka<span class="token operator">/</span>wiki
<span class="token operator">-</span> 在<span class="token number">1</span><span class="token punctuation">.</span>x版本项目还是活跃的<span class="token punctuation">,</span>但是在<span class="token number">2</span><span class="token punctuation">.</span>x版本中停止维护<span class="token punctuation">,</span>出现问题后果自负<span class="token operator">!!</span><span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544569.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544569.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200709233215860"></p>
<h4 id="2-Consul"><a href="#2-Consul" class="headerlink" title="2.Consul"></a>2.Consul</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>consul 简介
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>consul<span class="token punctuation">.</span>io
<span class="token operator">-</span> consul是一个可以提供服务发现，健康检查，多数据中心，Key<span class="token operator">/</span>Value存储等功能的分布式服务框架，用于实现分布式系统的服务发现与配置。与其他分布式服务注册与发现的方案，使用起来也较为简单。Consul用Golang实现，因此具有天然可移植性<span class="token punctuation">(</span>支持Linux、Windows和Mac OS X<span class="token punctuation">)</span>；安装包仅包含一个可执行文件，方便部署。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="安装consul"><a href="#安装consul" class="headerlink" title="安装consul"></a>安装consul</h5><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>下载consul
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>consul<span class="token punctuation">.</span>io<span class="token operator">/</span>downloads<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544219.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544219.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710103539186"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>安装consul
<span class="token operator">-</span> 官方安装视频地址<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>learn<span class="token punctuation">.</span>hashicorp<span class="token punctuation">.</span>com<span class="token operator">/</span>consul<span class="token operator">/</span>getting<span class="token operator">-</span>started<span class="token operator">/</span>install<span class="token punctuation">.</span>html
<span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">.</span>解压之后发现consul只有一个脚本文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544113.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544113.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710105007805"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>根据解压缩目录配置环境变量
<span class="token operator">-</span> 根据安装目录进行环境变量配置 <span class="token punctuation">[</span>这里是macos和linux系统配置<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544401.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544401.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710105305439"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>查看consul环境变量是否配置成功<span class="token punctuation">,</span>执行命令出现如下信息代表成功
<span class="token operator">-</span> consul <span class="token operator">-</span>v<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544701.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544701.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710105449741"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>启动consul服务
<span class="token operator">-</span> consul agent <span class="token operator">-</span>dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544563.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544563.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710105654356"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>访问consul的web服务端口
<span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8500</span>
	`consul默认服务端口是<span class="token number">8500</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544695.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544695.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710105912943"></p>
<h5 id="开发consul-客户端即微服务"><a href="#开发consul-客户端即微服务" class="headerlink" title="开发consul 客户端即微服务"></a>开发consul 客户端即微服务</h5><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>创建项目并引入consul客户端依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"> <span class="token comment">&lt;!--引入consul依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544442.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544442.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710113855944"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>编写properties配置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8889</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">consulclient8889</span>
<span class="token attr-name">spring.cloud.consul.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost														#注册consul服务的主机</span>
<span class="token attr-name">spring.cloud.consul.port</span><span class="token punctuation">=</span><span class="token attr-value">8500																	#注册consul服务的端口号</span>
<span class="token attr-name">spring.cloud.consul.discovery.register-health-check</span><span class="token punctuation">=</span><span class="token attr-value">false	    #关闭consu了服务的健康检查[不推荐]</span>
<span class="token attr-name">spring.cloud.consul.discovery.service-name</span><span class="token punctuation">=</span><span class="token attr-value">$&#123;spring.application.name&#125; #指定注册的服务名称 默认就是应用名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544894.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231544894.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713135437947"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>启动服务查看consul界面服务信息<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545743.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545743.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713135359150"></p>
<h5 id="consul-开启健康监控检查"><a href="#consul-开启健康监控检查" class="headerlink" title="consul 开启健康监控检查"></a>consul 开启健康监控检查</h5><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>开启consul健康监控
<span class="token operator">-</span> 默认情况consul监控健康是开启的<span class="token punctuation">,</span>但是必须依赖健康监控依赖才能正确监控健康状态所以直接启动会显示错误<span class="token punctuation">,</span>引入健康监控依赖之后服务正常<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- 这个包是用做健康度监控的--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545359.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545359.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713140146813"></p>
<h5 id="consul-关闭健康监控检查"><a href="#consul-关闭健康监控检查" class="headerlink" title="consul 关闭健康监控检查"></a>consul 关闭健康监控检查</h5><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8889</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">consulclient8889</span>
<span class="token attr-name">spring.cloud.consul.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost														#注册consul服务的主机</span>
<span class="token attr-name">spring.cloud.consul.port</span><span class="token punctuation">=</span><span class="token attr-value">8500																	#注册consul服务的端口号</span>
<span class="token attr-name">spring.cloud.consul.discovery.register-health-check</span><span class="token punctuation">=</span><span class="token attr-value">false	    						#关闭consu了服务的健康检查[不推荐]</span>
<span class="token attr-name">spring.cloud.consul.discovery.service-name</span><span class="token punctuation">=</span><span class="token attr-value">$&#123;spring.application.name&#125; 					#指定注册的服务名称 默认就是应用名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545544.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545544.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710114321913"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545382.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545382.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200710121728014"></p>
<h3 id="不同注册中心区别"><a href="#不同注册中心区别" class="headerlink" title="不同注册中心区别"></a>不同注册中心区别</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>CAP定理
<span class="token operator">-</span> CAP定理：CAP定理又称CAP原则，指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。
	`一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）
	`可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）
	`分区容忍性（P），就是高可用性，一个节点崩了，并不影响其它的节点（<span class="token number">100</span>个节点，挂了几个，不影响服务，越多机器越好）
	
# <span class="token number">2</span><span class="token punctuation">.</span>Eureka特点
<span class="token operator">-</span> Eureka中没有使用任何的数据强一致性算法保证不同集群间的Server的数据一致，仅通过数据拷贝的方式争取注册中心数据的最终一致性，虽然放弃数据强一致性但是换来了Server的可用性，降低了注册的代价，提高了集群运行的健壮性。

# <span class="token number">3</span><span class="token punctuation">.</span>Consul特点
<span class="token operator">-</span> 基于Raft算法，Consul提供强一致性的注册中心服务，但是由于Leader节点承担了所有的处理工作，势必加大了注册和发现的代价，降低了服务的可用性。通过Gossip协议，Consul可以很好地监控Consul集群的运行，同时可以方便通知各类事件，如Leader选择发生、Server地址变更等。

# <span class="token number">4</span><span class="token punctuation">.</span>zookeeper特点
<span class="token operator">-</span> 基于Zab协议，Zookeeper可以用于构建具备数据强一致性的服务注册与发现中心，而与此相对地牺牲了服务的可用性和提高了注册需要的时间。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>![image-20200710135837525](SpringCloud 微服务工具集v1.1.assets/image-20200710135837525.png)</p>
<hr>
<h2 id="7-服务间通信方式"><a href="#7-服务间通信方式" class="headerlink" title="7. 服务间通信方式"></a>7. 服务间通信方式</h2><p>接下来在整个微服务架构中,我们比较关心的就是服务间的服务改如何调用,有哪些调用方式?</p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545178.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545178.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713095528763"></p>
<blockquote>
<p>总结:<code>在springcloud中服务间调用方式主要是使用 http restful方式进行服务间调用</code></p>
</blockquote>
<h3 id="基于RestTemplate的服务调用"><a href="#基于RestTemplate的服务调用" class="headerlink" title="基于RestTemplate的服务调用"></a>基于RestTemplate的服务调用</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> spring框架提供的RestTemplate类可用于在应用中调用rest服务，它简化了与http服务的通信方式，统一了RESTful的标准，封装了http链接， 我们只需要传入url及返回值类型即可。相较于之前常用的HttpClient，RestTemplate是一种更优雅的调用RESTful服务的方式。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="1-RestTemplate-服务调用"><a href="#1-RestTemplate-服务调用" class="headerlink" title="1. RestTemplate 服务调用"></a>1. RestTemplate 服务调用</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>创建两个服务并注册到consul注册中心中
<span class="token operator">-</span> users    代表用户服务 端口为 <span class="token number">9999</span>
<span class="token operator">-</span> products 代表商品服务 端口为 <span class="token number">9998</span>
	`注意<span class="token operator">:</span>这里服务仅仅用来测试<span class="token punctuation">,</span>没有实际业务意义<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545824.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545824.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713101224125"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545044.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545044.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713101422031"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>在商品服务中提供服务方法<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;server.port&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/findAll"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"商品服务查询所有调用成功,当前服务端口:[&#123;&#125;]"</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"服务调用成功,服务提供端口为: "</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545303.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231545303.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713101553893"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>在用户服务中使用restTemplate进行调用<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231546519.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231546519.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713102053530"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/findAll"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用用户服务..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.使用restTemplate调用商品服务</span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> forObject <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9998/product/findAll"</span><span class="token punctuation">,</span> 
                                                     <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> forObject<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none"># 4.启动服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231546263.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231546263.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713102320469"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231546496.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231546496.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713140350189"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>测试服务调用
<span class="token operator">-</span> 浏览器访问用户服务 http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9999</span><span class="token operator">/</span>user<span class="token operator">/</span>findAll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547320.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547320.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713102454337"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547297.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547297.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713102616311"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>总结
<span class="token operator">-</span> rest Template是直接基于服务地址调用没有在服务注册中心获取服务<span class="token punctuation">,</span>也没有办法完成服务的负载均衡如果需要实现服务的负载均衡需要自己书写服务负载均衡策略。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="基于Ribbon的服务调用"><a href="#基于Ribbon的服务调用" class="headerlink" title="基于Ribbon的服务调用"></a>基于Ribbon的服务调用</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 官方网址<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>ribbon
<span class="token operator">-</span> Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="1-Ribbon-服务调用"><a href="#1-Ribbon-服务调用" class="headerlink" title="1.Ribbon 服务调用"></a>1.Ribbon 服务调用</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>项目中引入依赖
<span class="token operator">-</span> 说明<span class="token operator">:</span> 
	<span class="token number">1</span><span class="token punctuation">.</span>如果使用的是eureka client 和 consul client<span class="token punctuation">,</span>无须引入依赖<span class="token punctuation">,</span>因为在eureka<span class="token punctuation">,</span>consul中默认集成了ribbon组件
	<span class="token number">2</span><span class="token punctuation">.</span>如果使用的client中没有ribbon依赖需要显式引入如下依赖<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入ribbon依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>查看consul client中依赖的ribbon<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547855.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547855.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713140804414"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>使用restTemplate <span class="token operator">+</span> ribbon进行服务调用
<span class="token operator">-</span> 使用discovery client  进行客户端调用
<span class="token operator">-</span> 使用loadBalanceClient 进行客户端调用
<span class="token operator">-</span> 使用<span class="token label symbol">@loadBalanced</span>     进行客户端调用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3.1</span> 使用discovery Client形式调用<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

<span class="token comment">//获取服务列表</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">></span></span> products <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"服务ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> product <span class="token operator">:</span> products<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"服务主机:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"服务端口:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"服务地址:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none"># 3.2 使用loadBalance Client形式调用<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">;</span>
<span class="token comment">//根据负载均衡策略选取某一个服务调用</span>
<span class="token class-name">ServiceInstance</span> product <span class="token operator">=</span> loadBalancerClient<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"服务ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"服务主机:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"服务端口:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"服务地址:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none"># 3.3 使用@loadBalanced<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.整合restTemplate + ribbon</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//2.调用服务位置注入RestTemplate</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
<span class="token comment">//3.调用</span>
<span class="token class-name">String</span> forObject <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://服务ID/hello/hello?name="</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-Ribbon负载均衡策略"><a href="#2-Ribbon负载均衡策略" class="headerlink" title="2.Ribbon负载均衡策略"></a>2.Ribbon负载均衡策略</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>ribbon负载均衡算法
<span class="token operator">-</span> RoundRobinRule         		轮训策略	按顺序循环选择 Server
<span class="token operator">-</span> RandomRule             		随机策略	随机选择 Server
<span class="token operator">-</span> AvailabilityFilteringRule 可用过滤策略
 	`会先过滤由于多次访问故障而处于断路器跳闸状态的服务，还有并发的连接数量超过阈值的服务，然后对剩余的服务列表按照轮询策略进行访问

<span class="token operator">-</span> WeightedResponseTimeRule  响应时间加权策略   
	`根据平均响应的时间计算所有服务的权重，响应时间越快服务权重越大被选中的概率越高，刚启动时如果统计信息不足，则使用		
		RoundRobinRule策略，等统计信息足够会切换到

<span class="token operator">-</span> RetryRule                 重试策略          
	`先按照RoundRobinRule的策略获取服务，如果获取失败则在制定时间内进行重试，获取可用的服务。
	
<span class="token operator">-</span> BestAviableRule           最低并发策略     
	`会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547265.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547265.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713162940968"></p>
<h4 id="3-修改服务的默认负载均衡策略"><a href="#3-修改服务的默认负载均衡策略" class="headerlink" title="3.修改服务的默认负载均衡策略"></a>3.修改服务的默认负载均衡策略</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>修改服务默认随机策略
<span class="token operator">-</span> 服务id<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span>NFLoadBalancerRuleClassName<span class="token operator">=</span>com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>RandomRule
	`下面的products为服务的唯一标识<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">products<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span>NFLoadBalancerRuleClassName<span class="token operator">=</span>com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>RandomRule<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547558.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547558.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713163722927"></p>
<h4 id="4-Ribbon停止维护"><a href="#4-Ribbon停止维护" class="headerlink" title="4.Ribbon停止维护"></a>4.Ribbon停止维护</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>官方停止维护说明
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>ribbon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547974.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547974.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713195706787"></p>
<hr>
<h2 id="8-OpenFeign组件的使用"><a href="#8-OpenFeign组件的使用" class="headerlink" title="8.OpenFeign组件的使用"></a>8.OpenFeign组件的使用</h2><ul>
<li>思考: 使用RestTemplate+ribbon已经可以完成对端的调用，为什么还要使用feign？</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> restTemplateForObject <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://服务名/url?参数"</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 存在问题<span class="token operator">:</span>
<span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">.</span>每次调用服务都需要写这些代码<span class="token punctuation">,</span>存在大量的代码冗余
<span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">.</span>服务地址如果修改<span class="token punctuation">,</span>维护成本增高
<span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">.</span>使用时不够灵活<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="OpenFeign-组件"><a href="#OpenFeign-组件" class="headerlink" title="OpenFeign 组件"></a>OpenFeign 组件</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>openfeign<span class="token operator">/</span>reference<span class="token operator">/</span>html<span class="token operator">/</span>
<span class="token operator">-</span> Feign是一个声明式的伪Http客户端，它使得写Http客户端变得更简单。使用Feign，只需要创建一个接口并注解。它具有可插拔的注解特性<span class="token punctuation">(</span>可以使用springmvc的注解<span class="token punctuation">)</span>，可使用Feign 注解和JAX<span class="token operator">-</span>RS注解。Feign支持可插拔的编码器和解码器。Feign默认集成了Ribbon，默认实现了负载均衡的效果并且springcloud为feign添加了springmvc注解的支持。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="1-openFeign-服务调用"><a href="#1-openFeign-服务调用" class="headerlink" title="1.openFeign 服务调用"></a>1.openFeign 服务调用</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>服务调用方法引入依赖OpenFeign依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--Open Feign依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547986.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547986.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713201342374"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>入口类加入注解开启OpenFeign支持<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Users9999Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Users9999Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547379.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547379.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713201602139"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>创建一个客户端调用接口<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//value属性用来指定:调用服务名称</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"PRODUCTS"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductClient</span> <span class="token punctuation">&#123;</span>
  
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/findAll"</span><span class="token punctuation">)</span> <span class="token comment">//书写服务调用路径</span>
    <span class="token class-name">String</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547362.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547362.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713202133954"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>使用feignClient客户端对象调用服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//注入客户端对象</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ProductClient</span> productClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/findAllFeignClient"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findAllFeignClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"通过使用OpenFeign组件调用商品服务..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> msg <span class="token operator">=</span> productClient<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547333.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547333.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713202615159"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>访问并测试服务
<span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9999</span><span class="token operator">/</span>user<span class="token operator">/</span>findAllFeignClient<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547572.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547572.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713202802056"></p>
<h4 id="2-调用服务并传参"><a href="#2-调用服务并传参" class="headerlink" title="2.调用服务并传参"></a>2.调用服务并传参</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 服务和服务之间通信<span class="token punctuation">,</span>不仅仅是调用<span class="token punctuation">,</span>往往在调用过程中还伴随着参数传递<span class="token punctuation">,</span>接下来重点来看看OpenFeign在调用服务时如何传递参数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h6 id="GET方式调用服务传递参数"><a href="#GET方式调用服务传递参数" class="headerlink" title="GET方式调用服务传递参数"></a>GET方式调用服务传递参数</h6><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>GET方式调用服务传递参数
<span class="token operator">-</span> 在商品服务中加入需要传递参数的服务方法来进行测试
<span class="token operator">-</span> 在用户服务中进行调用商品服务中需要传递参数的服务方法进行测试<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1.商品服务中添加如下方法</span>
 <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/findOne"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> productId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"商品服务查询商品信息调用成功,当前服务端口:[&#123;&#125;]"</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"当前接收商品信息的id:[&#123;&#125;]"</span><span class="token punctuation">,</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"商品服务查询商品信息调用成功,当前服务端口: "</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"productId"</span><span class="token punctuation">,</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547136.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547136.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713203833730"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//2.用户服务中在product客户端中声明方法</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"PRODUCTS"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductClient</span> <span class="token punctuation">&#123;</span> 
	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/findOne"</span><span class="token punctuation">)</span>
 	<span class="token class-name">String</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"productId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547965.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231547965.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713204301830"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//3.用户服务中调用并传递参数</span>
<span class="token comment">//注入客户端对象</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ProductClient</span> productClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/findAllFeignClient"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findAllFeignClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"通过使用OpenFeign组件调用商品服务..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> msg <span class="token operator">=</span> productClient<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548775.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548775.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713204359700"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 测试访问<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548411.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548411.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713204827577"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548979.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548979.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713204851383"></p>
<h6 id="post方式调用服务传递参数"><a href="#post方式调用服务传递参数" class="headerlink" title="post方式调用服务传递参数"></a>post方式调用服务传递参数</h6><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>post方式调用服务传递参数
<span class="token operator">-</span> 在商品服务中加入需要传递参数的服务方法来进行测试
<span class="token operator">-</span> 在用户服务中进行调用商品服务中需要传递参数的服务方法进行测试<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.商品服务加入post方式请求并接受name</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/product/save"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"商品服务保存商品调用成功,当前服务端口:[&#123;&#125;]"</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"当前接收商品名称:[&#123;&#125;]"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"商品服务查询商品信息调用成功,当前服务端口: "</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548407.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548407.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713205125242"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//2.用户服务中在product客户端中声明方法</span>
<span class="token comment">//value属性用来指定:调用服务名称</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"PRODUCTS"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductClient</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/product/save"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548438.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548438.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713205734920"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//3.用户服务中调用并传递参数</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ProductClient</span> productClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/save"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到的商品信息名称:[&#123;&#125;]"</span><span class="token punctuation">,</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> save <span class="token operator">=</span> productClient<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用成功返回结果: "</span><span class="token operator">+</span>save<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> save<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548064.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548064.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713205823467"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 测试访问<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548603.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548603.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713205919054"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548533.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548533.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713210001477"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>传递对象类型参数
<span class="token operator">-</span> 商品服务定义对象
<span class="token operator">-</span> 商品服务定义对象接收方法
<span class="token operator">-</span> 用户服务调用商品服务定义对象参数方法进行参数传递<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.商品服务定义对象</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> bir<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548519.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548519.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713210437488"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//2.商品服务定义接收对象的方法</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/product/saveProduct"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">saveProduct</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"商品服务保存商品信息调用成功,当前服务端口:[&#123;&#125;]"</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"当前接收商品名称:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"商品服务查询商品信息调用成功,当前服务端口: "</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"product"</span><span class="token punctuation">,</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548657.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548657.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713210641668"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//3.将商品对象复制到用户服务中</span>
<span class="token comment">//4.用户服务中在product客户端中声明方法</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"PRODUCTS"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductClient</span> <span class="token punctuation">&#123;</span>
  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/product/saveProduct"</span><span class="token punctuation">)</span>
  <span class="token class-name">String</span> <span class="token function">saveProduct</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548588.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548588.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713211213241"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 5.在用户服务中调用保存商品信息服务</span>
<span class="token comment">//注入客户端对象</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ProductClient</span> productClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/saveProduct"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saveProduct</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到的商品信息:[&#123;&#125;]"</span><span class="token punctuation">,</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> save <span class="token operator">=</span> productClient<span class="token punctuation">.</span><span class="token function">saveProduct</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用成功返回结果: "</span><span class="token operator">+</span>save<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> save<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548545.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548545.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713211308524"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 测试<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548015.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548015.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713211338475"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548743.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231548743.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713211402844"></p>
<h4 id="3-OpenFeign超时设置"><a href="#3-OpenFeign超时设置" class="headerlink" title="3.OpenFeign超时设置"></a>3.OpenFeign超时设置</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>超时说明
<span class="token operator">-</span> 默认情况下<span class="token punctuation">,</span>openFiegn在进行服务调用时<span class="token punctuation">,</span>要求服务提供方处理业务逻辑时间必须在1S内返回<span class="token punctuation">,</span>如果超过1S没有返回则OpenFeign会直接报错<span class="token punctuation">,</span>不会等待服务执行<span class="token punctuation">,</span>但是往往在处理复杂业务逻辑是可能会超过1S<span class="token punctuation">,</span>因此需要修改OpenFeign的默认服务调用超时时间。
<span class="token operator">-</span> 调用超时会出现如下错误：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>模拟超时
<span class="token operator">-</span> 服务提供方加入线程等待阻塞<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549030.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549030.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713213322984"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>进行客户端调用<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549878.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549878.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713213415230"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>修改OpenFeign默认超时时间<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">feign.client.config.PRODUCTS.connectTimeout</span><span class="token punctuation">=</span><span class="token attr-value">5000  		#配置指定服务连接超时</span>
<span class="token attr-name">feign.client.config.PRODUCTS.readTimeout</span><span class="token punctuation">=</span><span class="token attr-value">5000		  	#配置指定服务等待超时</span>
<span class="token comment">#feign.client.config.default.connectTimeout=5000  		#配置所有服务连接超时</span>
<span class="token comment">#feign.client.config.default.readTimeout=5000			#配置所有服务等待超时</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-OpenFeign调用详细日志展示"><a href="#4-OpenFeign调用详细日志展示" class="headerlink" title="4.OpenFeign调用详细日志展示"></a>4.OpenFeign调用详细日志展示</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 往往在服务调用时我们需要详细展示feign的日志<span class="token punctuation">,</span>默认feign在调用是并不是最详细日志输出<span class="token punctuation">,</span>因此在调试程序时应该开启feign的详细日志展示。feign对日志的处理非常灵活可为每个feign客户端指定日志记录策略，每个客户端都会创建一个logger默认情况下logger的名称是feign的全限定名需要注意的是，feign日志的打印只会DEBUG级别做出响应。
<span class="token operator">-</span> 我们可以为feign客户端配置各自的logger<span class="token punctuation">.</span>lever对象，告诉feign记录那些日志logger<span class="token punctuation">.</span>lever有以下的几种值
	`NONE  不记录任何日志
	`BASIC 仅仅记录请求方法，url，响应状态代码及执行时间
	`HEADERS 记录Basic级别的基础上，记录请求和响应的header
	`FULL 记录请求和响应的header，body和元数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>开启日志展示<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">feign.client.config.PRODUCTS.loggerLevel</span><span class="token punctuation">=</span><span class="token attr-value">full  #开启指定服务日志展示</span>
<span class="token comment">#feign.client.config.default.loggerLevel=full  #全局开启服务日志展示</span>
<span class="token attr-name">logging.level.com.baizhi.feignclients</span><span class="token punctuation">=</span><span class="token attr-value">debug    #指定feign调用客户端对象所在包,必须是debug级别</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>测试服务调用查看日志<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549049.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549049.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200713215108861"></p>
<hr>
<h2 id="9-Hystrix组件使用"><a href="#9-Hystrix组件使用" class="headerlink" title="9.Hystrix组件使用"></a>9.Hystrix组件使用</h2><h3 id="Hystrix组件"><a href="#Hystrix组件" class="headerlink" title="Hystrix组件"></a>Hystrix组件</h3><p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549571.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549571.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200715123359665"></p>
<p>In a distributed environment, inevitably some of the many service dependencies will fail. Hystrix is a library that helps you control the interactions between these distributed services by adding latency tolerance and fault tolerance logic. Hystrix does this by isolating points of access between the services, stopping cascading failures across them, and providing fallback options, all of which improve your system’s overall resiliency.        –[摘自官方]</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>Hystrix
<span class="token operator">-</span> 译<span class="token operator">:</span> 在分布式环境中，许多服务依赖项不可避免地会失败。Hystrix是一个库，它通过添加延迟容忍和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点、停止它们之间的级联故障以及提供后备选项来实现这一点，所有这些都可以提高系统的整体弹性。
<span class="token operator">-</span> 通俗定义<span class="token operator">:</span> Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统中，许多依赖不可避免的会调用失败，超时、异常等，Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障<span class="token punctuation">(</span>服务雪崩现象<span class="token punctuation">)</span>，提高分布式系统的弹性。


# <span class="token number">1</span><span class="token punctuation">.</span>作用
<span class="token operator">-</span> hystrix 用来保护微服务系统 实现 服务降级  服务熔断

<span class="token operator">-</span> 服务雪崩  
<span class="token operator">-</span> 服务降级
<span class="token operator">-</span> 服务熔断<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-服务雪崩"><a href="#1-服务雪崩" class="headerlink" title="1.服务雪崩"></a>1.服务雪崩</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>服务雪崩
<span class="token operator">-</span> 在微服务之间进行服务调用是由于某一个服务故障，导致级联服务故障的现象，称为雪崩效应。雪崩效应描述的是提供方不可用，导致消费方不可用并将不可用逐渐放大的过程。
# <span class="token number">2</span><span class="token punctuation">.</span>图解雪崩效应
<span class="token operator">-</span> 如存在如下调用链路<span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549964.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549964.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200715151728240"></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 而此时，Service A的流量波动很大，流量经常会突然性增加！那么在这种情况下，就算Service A能扛得住请求，Service B和Service C未必能扛得住这突发的请求。此时，如果Service C因为抗不住请求，变得不可用。那么Service B的请求也会阻塞，慢慢耗尽Service B的线程资源，Service B就会变得不可用。紧接着，Service A也会不可用，这一过程如下图所示<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549276.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549276.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200715152623313"></p>
<h4 id="2-服务熔断"><a href="#2-服务熔断" class="headerlink" title="2.服务熔断"></a>2.服务熔断</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 服务熔断
<span class="token operator">-</span> “熔断器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器<span class="token punctuation">(</span>hystrix<span class="token punctuation">)</span>的故障监控，某个异常条件被触发，直接熔断整个服务。向调用方法返回一个符合预期的、可处理的备选响应<span class="token punctuation">(</span>FallBack<span class="token punctuation">)</span><span class="token punctuation">,</span>而不是长时间的等待或者抛出调用方法无法处理的异常，就保证了服务调用方的线程不会被长时间占用，避免故障在分布式系统中蔓延，乃至雪崩。如果目标服务情况好转则恢复调用。服务熔断是解决服务雪崩的重要手段。

# 服务熔断图示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549551.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549551.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717085946385"></p>
<h4 id="3-服务降级"><a href="#3-服务降级" class="headerlink" title="3.服务降级"></a>3.服务降级</h4><pre class="line-numbers language-none"><code class="language-none"># 服务降级说明
- 服务压力剧增的时候根据当前的业务情况及流量对一些服务和页面有策略的降级，以此缓解服务器的压力，以保证核心任务的进行。同时保证部分甚至大部分任务客户能得到正确的响应。也就是当前的请求处理不了了或者出错了，给一个默认的返回。

- 服务降级: 关闭微服务系统中某些边缘服务 保证系统核心服务正常运行
- 12 淘宝  京东
- 删除订单 --- 关闭订单    确认收货 ----&gt;     服务繁忙,!!!

# 服务降级图示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549394.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549394.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717112327729"></p>
<h4 id="4-降级和熔断总结"><a href="#4-降级和熔断总结" class="headerlink" title="4.降级和熔断总结"></a>4.降级和熔断总结</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>共同点
<span class="token operator">-</span> 目的很一致，都是从可用性可靠性着想，为防止系统的整体缓慢甚至崩溃，采用的技术手段；
<span class="token operator">-</span> 最终表现类似，对于两者来说，最终让用户体验到的是某些功能暂时不可达或不可用；
<span class="token operator">-</span> 粒度一般都是服务级别，当然，业界也有不少更细粒度的做法，比如做到数据持久层（允许查询，不允许增删改）；
<span class="token operator">-</span> 自治性要求很高，熔断模式一般都是服务基于策略的自动触发，降级虽说可人工干预，但在微服务架构下，完全靠人显然不可能，开关预置、配置中心都是必要手段；sentinel

# <span class="token number">2</span><span class="token punctuation">.</span>异同点
<span class="token operator">-</span> 触发原因不太一样，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；
<span class="token operator">-</span> 管理目标的层次不太一样，熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务边缘服务开始）

# <span class="token number">3</span><span class="token punctuation">.</span>总结
<span class="token operator">-</span> 熔断必会触发降级<span class="token punctuation">,</span>所以熔断也是降级一种<span class="token punctuation">,</span>区别在于熔断是对调用链路的保护<span class="token punctuation">,</span>而降级是对系统过载的一种保护处理<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5-服务熔断的实现"><a href="#5-服务熔断的实现" class="headerlink" title="5.服务熔断的实现"></a>5.服务熔断的实现</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>服务熔断的实现思路
<span class="token operator">-</span> 引入hystrix依赖<span class="token punctuation">,</span>并开启熔断器<span class="token punctuation">(</span>断路器<span class="token punctuation">)</span>
<span class="token operator">-</span> 模拟降级方法
<span class="token operator">-</span> 进行调用测试<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>项目中引入hystrix依赖 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入hystrix--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549279.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549279.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200716090932981"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>开启断路器<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span>  <span class="token comment">//用来开启断路器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Products9998Application</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Products9998Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549402.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549402.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200716094200460"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>使用HystrixCommand注解实现断路<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//服务熔断</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/break"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"testBreakFall"</span> <span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testBreak</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收的商品id为: "</span><span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"数据不合法!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token string">"当前接收商品id: "</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testBreakFall</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string">"当前数据不合法: "</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549792.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231549792.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717090743474"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>访问测试
<span class="token operator">-</span> 正常参数访问
<span class="token operator">-</span> 错误参数访问<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550172.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550172.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717090841831"></p>
<p>![image-20200717091028876](SpringCloud 微服务工具集v1.1.assets/image-20200717091028876.png)</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>总结
<span class="token operator">-</span> 从上面演示过程中会发现如果触发一定条件断路器会自动打开<span class="token punctuation">,</span>过了一点时间正常之后又会关闭。那么断路器打开条件是什么呢？<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>断路器打开条件
<span class="token operator">-</span> 官网<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>netflix<span class="token operator">/</span><span class="token number">2.2</span><span class="token punctuation">.</span>x<span class="token operator">/</span>reference<span class="token operator">/</span>html<span class="token operator">/</span>#circuit<span class="token operator">-</span>breaker<span class="token operator">-</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>circuit<span class="token operator">-</span>breaker<span class="token operator">-</span>with<span class="token operator">-</span>hystrix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>A service failure in the lower level of services can cause cascading failure all the way up to the user. When calls to a particular service exceed <code>circuitBreaker.requestVolumeThreshold</code> (default: 20 requests) and the failure percentage is greater than <code>circuitBreaker.errorThresholdPercentage</code> (default: &gt;50%) in a rolling window defined by <code>metrics.rollingStats.timeInMilliseconds</code> (default: 10 seconds), the circuit opens and the call is not made. In cases of error and an open circuit, a fallback can be provided by the developer.                                                                        –摘自官方</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 原文翻译之后<span class="token punctuation">,</span>总结打开关闭的条件<span class="token operator">:</span>
<span class="token operator">-</span> <span class="token number">1</span>、  当满足一定的阀值的时候（默认<span class="token number">10</span>秒内超过<span class="token number">20</span>个请求次数）
<span class="token operator">-</span> <span class="token number">2</span>、  当失败率达到一定的时候（默认<span class="token number">10</span>秒内超过<span class="token number">50</span><span class="token operator">%</span>的请求失败）
<span class="token operator">-</span> <span class="token number">3</span>、  到达以上阀值，断路器将会开启
<span class="token operator">-</span> <span class="token number">4</span>、  当开启的时候，所有请求都不会进行转发
<span class="token operator">-</span> <span class="token number">5</span>、  一段时间之后（默认是<span class="token number">5</span>秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。重复<span class="token number">4</span>和<span class="token number">5</span>。

# 面试重点问题<span class="token operator">:</span> 断路器流程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550469.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550469.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717092819616"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">7</span><span class="token punctuation">.</span>默认的服务FallBack处理方法
<span class="token operator">-</span> 如果为每一个服务方法开发一个降级<span class="token punctuation">,</span>对于我们来说<span class="token punctuation">,</span>可能会出现大量的代码的冗余<span class="token punctuation">,</span>不利于维护<span class="token punctuation">,</span>这个时候就需要加入默认服务降级处理方法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/hystrix"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"testHystrixFallBack"</span><span class="token punctuation">)</span> <span class="token comment">//通过HystrixCommand降级处理 指定出错的方法</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHystrix</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收名称为: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">"服务["</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">"]响应成功,当前接收名称为:"</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//服务降级处理</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHystrixFallBack</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> port <span class="token operator">+</span> <span class="token string">"当前服务已经被降级处理!!!,接收名称为: "</span><span class="token operator">+</span>name<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550976.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550976.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200716095016332"></p>
<h4 id="6-服务降级的实现"><a href="#6-服务降级的实现" class="headerlink" title="6.服务降级的实现"></a>6.服务降级的实现</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 服务降级<span class="token operator">:</span> 站在系统整体负荷角度 实现<span class="token operator">:</span> 关闭系统中某些边缘服务 保证系统核心服务运行
	Emps 核心服务   Depts 边缘服务

# <span class="token number">1</span><span class="token punctuation">.</span>客户端openfeign <span class="token operator">+</span> hystrix实现服务降级实现
<span class="token operator">-</span> 引入hystrix依赖
<span class="token operator">-</span> 配置文件开启feign支持hystrix
<span class="token operator">-</span> 在feign客户端调用加入fallback指定降级处理
<span class="token operator">-</span> 开发降级处理方法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>开启openfeign支持服务降级<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">feign.hystrix.enabled</span><span class="token punctuation">=</span><span class="token attr-value">true #开启openfeign支持降级</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none"># 3.在openfeign客户端中加如Hystrix<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"PRODUCTS"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">ProductFallBack</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductClient</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/hystrix"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">testHystrix</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550196.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550196.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200716101101091"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>开发fallback处理类<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductFallBack</span> <span class="token keyword">implements</span> <span class="token class-name">ProductClient</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHystrix</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"我是客户端的Hystrix服务实现!!!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550309.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550309.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717101921108"></p>
<h4 id="7-Hystrix-Dashboard-仪表盘"><a href="#7-Hystrix-Dashboard-仪表盘" class="headerlink" title="7.Hystrix Dashboard(仪表盘)"></a>7.Hystrix Dashboard(仪表盘)</h4><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># Hystrix DashBoard 仪表盘 

# <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> Hystrix Dashboard的一个主要优点是它收集了关于每个HystrixCommand的一组度量。Hystrix仪表板以高效的方式显示每个断路器的运行状况。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550324.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550324.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200716161556743"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>项目中引入依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入hystrix dashboard 依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>入口类中开启hystrix dashboard<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableHystrixDashboard</span> <span class="token comment">//开启监控面板</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hystrixdashboard9990Application</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Hystrixdashboard9990Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550490.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550490.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717154912206"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>启动hystrix dashboard应用
<span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token function">9990</span><span class="token punctuation">(</span>dashboard端口<span class="token punctuation">)</span><span class="token operator">/</span>hystrix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550472.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550472.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717155059512"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>监控的项目中入口类中加入监控路径配置<span class="token punctuation">[</span>新版本坑<span class="token punctuation">]</span><span class="token punctuation">,</span>并启动监控项目<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">HystrixMetricsStreamServlet</span> streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">ServletRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">"/hystrix.stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"HystrixMetricsStreamServlet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550011.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550011.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717155120335"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>通过监控界面监控<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550344.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550344.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717155258994"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>点击监控<span class="token punctuation">,</span>一致loading<span class="token punctuation">,</span>打开控制台发现报错<span class="token punctuation">[</span>特别坑<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550948.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550948.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717155555786"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 解决方案
<span class="token operator">-</span> 新版本中springcloud将jquery版本升级为<span class="token number">3.4</span><span class="token punctuation">.</span><span class="token number">1</span>，定位到monitor<span class="token punctuation">.</span>ftlh文件中，js的写法如下：
	$<span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	
<span class="token operator">-</span> jquery <span class="token number">3.4</span><span class="token punctuation">.</span><span class="token number">1</span>已经废弃上面写法

<span class="token operator">-</span> 修改方案 修改monitor<span class="token punctuation">.</span>ftlh为如下调用方式：
	$<span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"load"</span></span><span class="token punctuation">,</span><span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
<span class="token operator">-</span> 编译jar源文件，重新打包引入后，界面正常响应。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550736.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550736.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717160636218"></p>
<h4 id="8-Hystrix停止维护"><a href="#8-Hystrix停止维护" class="headerlink" title="8.Hystrix停止维护"></a>8.Hystrix停止维护</h4><p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550589.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231550589.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717161223806"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551813.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551813.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200717161400285"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 官方地址<span class="token operator">:</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>Hystrix
<span class="token operator">-</span> 翻译<span class="token operator">:</span>Hystrix（版本<span class="token number">1.5</span><span class="token punctuation">.</span><span class="token number">18</span>）足够稳定，可以满足Netflix对我们现有应用的需求。同时，我们的重点已经转移到对应用程序的实时性能作出反应的更具适应性的实现，而不是预先配置的设置（例如，通过自适应并发限制）。对于像Hystrix这样的东西有意义的情况，我们打算继续在现有的应用程序中使用Hystrix，并在新的内部项目中利用诸如resilience4j这样的开放和活跃的项目。我们开始建议其他人也这样做。 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span> sentinel 流量卫兵
<span class="token operator">-</span> Dashboard也被废弃<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="10-Gateway组件使用"><a href="#10-Gateway组件使用" class="headerlink" title="10.Gateway组件使用"></a>10.Gateway组件使用</h2><h3 id="什么是服务网关"><a href="#什么是服务网关" class="headerlink" title="什么是服务网关"></a>什么是服务网关</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 网关统一服务入口，可方便实现对平台众多服务接口进行管控，对访问服务的身份认证、防报文重放与防数据篡改、功能调用的业务鉴权、响应数据的脱敏、流量与并发控制，甚至基于API调用的计量或者计费等等。
<span class="token operator">-</span> 网关 <span class="token operator">=</span>  路由转发 <span class="token operator">+</span> 过滤器
	`路由转发：接收一切外界请求，转发到后端的微服务上去；
	`在服务网关中可以完成一系列的横切功能，例如权限校验、限流以及监控等，这些都可以通过过滤器完成
	
# <span class="token number">2</span><span class="token punctuation">.</span>为什么需要网关
 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">.</span>网关可以实现服务的统一管理
 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">.</span>网关可以解决微服务中通用代码的冗余问题<span class="token punctuation">(</span>如权限控制<span class="token punctuation">,</span>流量监控<span class="token punctuation">,</span>限流等<span class="token punctuation">)</span>

# <span class="token number">3</span><span class="token punctuation">.</span>网关组件在微服务中架构<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551990.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551990.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200720171205828"></p>
<h3 id="服务网关组件"><a href="#服务网关组件" class="headerlink" title="服务网关组件"></a>服务网关组件</h3><h4 id="zuul-1-x-2-x-netflix-组件"><a href="#zuul-1-x-2-x-netflix-组件" class="headerlink" title="zuul 1.x  2.x(netflix 组件)"></a>zuul 1.x  2.x(netflix 组件)</h4><p>Zuul is the front door for all requests from devices and web sites to the backend of the Netflix streaming application. As an edge service application, Zuul is built to enable dynamic routing, monitoring, resiliency and security.</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>原文翻译
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Netflix<span class="token operator">/</span>zuul<span class="token operator">/</span>wiki
<span class="token operator">-</span> zul是从设备和网站到Netflix流媒体应用程序后端的所有请求的前门。作为一个边缘服务应用程序，zul被构建为支持动态路由、监视、弹性和安全性。

# <span class="token number">1</span><span class="token punctuation">.</span>zuul版本说明
<span class="token operator">-</span> 目前zuul组件已经从<span class="token number">1.0</span>更新到<span class="token number">2.0</span>，但是作为springcloud官方不再推荐使用zuul2<span class="token punctuation">.</span><span class="token number">0</span>，但是依然支持zuul2<span class="token punctuation">.</span>

# <span class="token number">2</span><span class="token punctuation">.</span>springcloud 官方集成zuul文档
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>netflix<span class="token operator">/</span><span class="token number">2.2</span><span class="token punctuation">.</span>x<span class="token operator">/</span>reference<span class="token operator">/</span>html<span class="token operator">/</span>#netflix<span class="token operator">-</span>zuul<span class="token operator">-</span>starter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="gateway-spring"><a href="#gateway-spring" class="headerlink" title="gateway (spring)"></a>gateway (spring)</h4><p>This project provides a library for building an API Gateway on top of Spring MVC. Spring Cloud Gateway aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>原文翻译
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>projects<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>gateway
<span class="token operator">-</span> 这个项目提供了一个在springmvc之上构建API网关的库。springcloudgateway旨在提供一种简单而有效的方法来路由到api，并为api提供横切关注点，比如：安全性、监控<span class="token operator">/</span>度量和弹性。

# <span class="token number">1</span><span class="token punctuation">.</span>特性
<span class="token operator">-</span> 基于springboot2<span class="token punctuation">.</span>x 和 spring webFlux 和 Reactor 构建 响应式异步非阻塞IO模型
<span class="token operator">-</span> 动态路由
<span class="token operator">-</span> 请求过滤<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="1-开发网关动态路由"><a href="#1-开发网关动态路由" class="headerlink" title="1.开发网关动态路由"></a>1.开发网关动态路由</h6><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>翻译
<span class="token operator">-</span> 网关配置有两种方式一种是快捷方式<span class="token punctuation">(</span>Java代码编写网关<span class="token punctuation">)</span><span class="token punctuation">,</span>一种是完全展开方式<span class="token punctuation">(</span>配置文件方式<span class="token punctuation">)</span><span class="token punctuation">[</span>推荐<span class="token punctuation">]</span>

# <span class="token number">1</span><span class="token punctuation">.</span>创建项目引入网关依赖<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入gateway网关依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551554.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551554.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200720175051402"></p>
<ul>
<li><strong>快捷方式配置路由</strong></li>
</ul>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>编写网关配置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">spring:
  application:
    name: gateway
  cloud:
    consul:
      host: localhost
      port: 8500
    gateway:
      routes:
        - id: user_route	# 指定路由唯一标识,理论上是可以随便写,但是一般是server.name
          uri: http:&#x2F;&#x2F;localhost:9999&#x2F; # 指定路由服务的地址
          predicates:   #断言
            - Path&#x3D;&#x2F;user&#x2F;**	  # 指定路由规则,只有路径是这个,才可以通过

        - id: product_route
          uri: http:&#x2F;&#x2F;localhost:9998&#x2F;
          predicates:
            - Path&#x3D;&#x2F;product&#x2F;**
server:
  port: 8989<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>启动gateway网关项目
<span class="token operator">-</span> 直接启动报错<span class="token operator">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551349.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551349.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200720212535357"></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 在启动日志中发现,gateway为了效率使用webflux进行异步非阻塞模型的实现,因此和原来的web包冲突,去掉原来的web即可<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551361.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551361.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200720212653494"></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 再次启动成功启动<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551144.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551144.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200720213657788"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>测试网关路由转发
<span class="token operator">-</span> 测试通过网关访问用户服务<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8989</span><span class="token operator">/</span>user<span class="token operator">/</span>findOne<span class="token operator">?</span>productId<span class="token operator">=</span><span class="token number">21</span>
<span class="token operator">-</span> 测试通过网关访问商品服务<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8989</span><span class="token operator">/</span>product<span class="token operator">/</span>findOne<span class="token operator">?</span>productId<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>java方式配置路由</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"order_route"</span><span class="token punctuation">,</span> r <span class="token operator">-></span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/order/**"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9997"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551401.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551401.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721103141491"></p>
<h6 id="2-查看网关路由规则列表"><a href="#2-查看网关路由规则列表" class="headerlink" title="2.查看网关路由规则列表"></a>2.查看网关路由规则列表</h6><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> gateway提供路由访问规则列表的web界面<span class="token punctuation">,</span>但是默认是关闭的<span class="token punctuation">,</span>如果想要查看服务路由规则可以在配置文件中开启<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">management:
  endpoints:
    web:
      exposure:
        include: &quot;*&quot;   #开启所有web端点暴露<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 访问路由管理列表地址
<span class="token list punctuation">-</span> http://localhost:8989/actuator/gateway/routes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551625.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551625.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200720220647899"></p>
<h6 id="3-配置路由服务负载均衡"><a href="#3-配置路由服务负载均衡" class="headerlink" title="3.配置路由服务负载均衡"></a>3.配置路由服务负载均衡</h6><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 现有路由配置方式<span class="token punctuation">,</span>都是基于服务地址写死的路由转发<span class="token punctuation">,</span>能不能根据服务名称进行路由转发同时实现负载均衡的呢<span class="token operator">?</span>

# <span class="token number">2</span><span class="token punctuation">.</span>动态路由以及负载均衡转发配置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">spring:
  application:
    name: gateway
  cloud:
    consul:
      host: localhost
      port: 8500
    gateway:
      routes:
        - id: user_route
          #uri: http:&#x2F;&#x2F;localhost:9999&#x2F;
          uri: lb:&#x2F;&#x2F;users							# lb代表转发后台服务使用负载均衡,users代表服务注册中心上的服务名
          predicates:
            - Path&#x3D;&#x2F;user&#x2F;**

        - id: product_route
          #uri: http:&#x2F;&#x2F;localhost:9998&#x2F;
          uri: lb:&#x2F;&#x2F;products          # lb(loadbalance)代表负载均衡转发路由
          predicates:
            - Path&#x3D;&#x2F;product&#x2F;**
      discovery:
        locator:
          enabled: true 							#开启根据服务名动态获取路由<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551839.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551839.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721110013966"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551397.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551397.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721110040104"></p>
<h6 id="4-常用路由predicate-断言-验证"><a href="#4-常用路由predicate-断言-验证" class="headerlink" title="4.常用路由predicate(断言,验证)"></a>4.常用路由predicate(断言,验证)</h6><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>Gateway支持多种方式的predicate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551757.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551757.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721112751340"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token operator">-</span> After<span class="token operator">=</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span>21T11<span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">33.993</span><span class="token operator">+</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">[</span>Asia<span class="token operator">/</span>Shanghai<span class="token punctuation">]</span>  			`指定日期之后的请求进行路由
<span class="token operator">-</span> Before<span class="token operator">=</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span>21T11<span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">33.993</span><span class="token operator">+</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">[</span>Asia<span class="token operator">/</span>Shanghai<span class="token punctuation">]</span>       `指定日期之前的请求进行路由
<span class="token operator">-</span> Between<span class="token operator">=</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span>20T17<span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">47.789</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">[</span>America<span class="token operator">/</span>Denver<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span>21T17<span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">47.789</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">[</span>America<span class="token operator">/</span>Denver<span class="token punctuation">]</span>
<span class="token operator">-</span> Cookie<span class="token operator">=</span>username<span class="token punctuation">,</span>chenyn																		`基于指定cookie的请求进行路由
<span class="token operator">-</span> Cookie<span class="token operator">=</span>username<span class="token punctuation">,</span><span class="token punctuation">[</span>A<span class="token operator">-</span>Za<span class="token operator">-</span>z0<span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">+</span>															`基于指定cookie的请求进行路由	
	`curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8989</span><span class="token operator">/</span>user<span class="token operator">/</span>findAll <span class="token operator">--</span>cookie <span class="token string-literal singleline"><span class="token string">"username=zhangsna"</span></span>
<span class="token operator">-</span> Header<span class="token operator">=</span>X<span class="token operator">-</span>Request<span class="token operator">-</span>Id<span class="token punctuation">,</span> \d<span class="token operator">+</span>																 ``基于请求头中的指定属性的正则匹配路由<span class="token punctuation">(</span>这里全是整数<span class="token punctuation">)</span>
	`curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8989</span><span class="token operator">/</span>user<span class="token operator">/</span>findAll <span class="token operator">-</span>H <span class="token string-literal singleline"><span class="token string">"X-Request-Id:11"</span></span>
<span class="token operator">-</span> Method<span class="token operator">=</span>GET<span class="token punctuation">,</span>POST																						 `基于指定的请求方式请求进行路由

<span class="token operator">-</span> 官方更多<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>static<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>gateway<span class="token operator">/</span><span class="token number">2.2</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">.</span>RELEASE<span class="token operator">/</span>reference<span class="token operator">/</span>html<span class="token operator">/</span>#the<span class="token operator">-</span>cookie<span class="token operator">-</span>route<span class="token operator">-</span>predicate<span class="token operator">-</span>factory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>使用predicate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">spring:
  application:
    name: gateway
  cloud:
    consul:
      host: localhost
      port: 8500
    gateway:
      routes:
        - id: user_route
          #uri: http:&#x2F;&#x2F;localhost:9999&#x2F;
          uri: lb:&#x2F;&#x2F;users
          predicates:
            - Path&#x3D;&#x2F;user&#x2F;**
            - After&#x3D;2020-07-21T11:39:33.993+08:00[Asia&#x2F;Shanghai]
            - Cookie&#x3D;username,[A-Za-z0-9]+
            -  Header&#x3D;X-Request-Id, \d+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551049.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551049.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721152720455"></p>
<h6 id="5-常用的Filter以及自定义filter"><a href="#5-常用的Filter以及自定义filter" class="headerlink" title="5.常用的Filter以及自定义filter"></a>5.常用的Filter以及自定义filter</h6><p>Route filters allow the modification of the incoming HTTP request or outgoing HTTP response in some manner. Route filters are scoped to a particular route. Spring Cloud Gateway includes many built-in GatewayFilter Factories.</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>原文翻译
<span class="token operator">-</span> 官网<span class="token operator">:</span> 
	https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>static<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>gateway<span class="token operator">/</span><span class="token number">2.2</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">.</span>RELEASE<span class="token operator">/</span>reference<span class="token operator">/</span>html<span class="token operator">/</span>#gatewayfilter<span class="token operator">-</span>factories
	
<span class="token operator">-</span> 路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。路由筛选器的作用域是特定路由。springcloudgateway包括许多内置的GatewayFilter工厂。

# <span class="token number">2</span><span class="token punctuation">.</span>作用
<span class="token operator">-</span> 当我们有很多个服务时，比如下图中的user<span class="token operator">-</span>service、order<span class="token operator">-</span>service、product<span class="token operator">-</span>service等服务，客户端请求各个服务的Api时，每个服务都需要做相同的事情，比如鉴权、限流、日志输出等。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551485.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551485.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721161002001"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551456.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551456.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721161421845"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>使用内置过滤器<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551790.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231551790.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721152425733"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token operator">-</span> AddRequestHeader<span class="token operator">=</span>X<span class="token operator">-</span>Request<span class="token operator">-</span>red<span class="token punctuation">,</span> blue						`增加请求头的filter`
<span class="token operator">-</span> AddRequestParameter<span class="token operator">=</span>red<span class="token punctuation">,</span> blue										`增加请求参数的filterr`
<span class="token operator">-</span> AddResponseHeader<span class="token operator">=</span>X<span class="token operator">-</span>Response<span class="token operator">-</span>Red<span class="token punctuation">,</span> AAA						`增加响应头filter`
<span class="token operator">-</span> PrefixPath<span class="token operator">=</span><span class="token operator">/</span>emp																	`增加前缀的filter`
<span class="token operator">-</span> StripPrefix<span class="token operator">=</span><span class="token number">2</span>																		`去掉前缀的filter`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>使用自定义filter<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"进入自定义的filter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户身份信息合法,放行请求继续执行!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"非法用户,拒绝访问!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552240.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552240.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721164304994"></p>
<hr>
<h2 id="11-Config组件-使用"><a href="#11-Config组件-使用" class="headerlink" title="11.Config组件 使用"></a>11.Config组件 使用</h2><h3 id="什么是Config"><a href="#什么是Config" class="headerlink" title="什么是Config"></a>什么是Config</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>static<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>config<span class="token operator">/</span><span class="token number">2.2</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">.</span>RELEASE<span class="token operator">/</span>reference<span class="token operator">/</span>html<span class="token operator">/</span>#_spring_cloud_config_server

<span class="token operator">-</span> <span class="token function">config</span><span class="token punctuation">(</span>配置<span class="token punctuation">)</span>又称为 统一配置中心顾名思义<span class="token punctuation">,</span>就是将配置统一管理<span class="token punctuation">,</span>配置统一管理的好处是在日后大规模集群部署服务应用时相同的服务配置一致<span class="token punctuation">,</span>日后再修改配置只需要统一修改全部同步<span class="token punctuation">,</span>不需要一个一个服务手动维护。


# <span class="token number">1</span><span class="token punctuation">.</span>统一配置中心组件流程图<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552615.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552615.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721180134903"></p>
<h3 id="Config-Server-开发"><a href="#Config-Server-开发" class="headerlink" title="Config Server 开发"></a>Config Server 开发</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>引入依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入统一配置中心--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>开启统一配置中心服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Configserver7878Application</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Configserver7878Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552198.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552198.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721182003376"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>修改配置文件<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">7878</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">configserver</span>
<span class="token attr-name">spring.cloud.consul.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost</span>
<span class="token attr-name">spring.cloud.consul.port</span><span class="token punctuation">=</span><span class="token attr-value">8500</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552563.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552563.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721182105648"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>直接启动服务报错
<span class="token operator">-</span>  没有指定远程仓库的相关配置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552831.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552831.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721182142000"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>创建远程仓库
<span class="token operator">-</span> github创建一个仓库<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552584.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552584.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721183541178"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>复制仓库地址
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>chenyn<span class="token operator">-</span>java<span class="token operator">/</span>configservers<span class="token punctuation">.</span>git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552622.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552622.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721183727767"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">7</span><span class="token punctuation">.</span>在统一配置中心服务中修改配置文件指向远程仓库地址<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>chenyn<span class="token operator">-</span>java<span class="token operator">/</span>configservers<span class="token punctuation">.</span>git   指定仓库的url
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>default<span class="token operator">-</span>label<span class="token operator">=</span>master									指定访问的分支
#spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>username<span class="token operator">=</span>       私有仓库访问用户名
#spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>password<span class="token operator">=</span>		私有仓库访问密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">8</span><span class="token punctuation">.</span>再次启动统一配置中心<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552389.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552389.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721221656436"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">9</span><span class="token punctuation">.</span>拉取远端配置 <span class="token punctuation">[</span>三种方式<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">.</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>test<span class="token operator">-</span>xxxx<span class="token punctuation">.</span>properties
<span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">.</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>test<span class="token operator">-</span>xxxx<span class="token punctuation">.</span>json
<span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">.</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>test<span class="token operator">-</span>xxxx<span class="token punctuation">.</span>yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552515.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552515.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200721221951670"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">10</span><span class="token punctuation">.</span>拉取远端配置规则
<span class="token operator">-</span> label<span class="token operator">/</span>name<span class="token operator">-</span>profiles<span class="token punctuation">.</span>yml|properties|json
	`label   代表去那个分支获取 默认使用master分支
	`name    代表读取那个具体的配置文件文件名称
	`profile 代表读取配置文件环境<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552386.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552386.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722105313716"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">11</span><span class="token punctuation">.</span>查看拉取配置详细信息
<span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>client<span class="token operator">/</span>dev       <span class="token punctuation">[</span>client<span class="token operator">:</span>代表远端配置名称<span class="token punctuation">]</span><span class="token punctuation">[</span>dev<span class="token operator">:</span>代表远程配置的环境<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552803.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552803.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722105950808"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">12</span><span class="token punctuation">.</span>指定分支和本地仓库位置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>basedir<span class="token operator">=</span><span class="token operator">/</span>localresp 		#一定要是一个空目录<span class="token punctuation">,</span>在首次会将该目录清空
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token punctuation">.</span>git<span class="token punctuation">.</span>default<span class="token operator">-</span>label<span class="token operator">=</span>master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="Config-Client-开发"><a href="#Config-Client-开发" class="headerlink" title="Config Client 开发"></a>Config Client 开发</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>项目中引入config client依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入config client--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>编写配置文件<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.cloud.config.discovery.enabled</span><span class="token punctuation">=</span><span class="token attr-value">true                #开启统一配置中心服务</span>
<span class="token attr-name">spring.cloud.config.discovery.service-id</span><span class="token punctuation">=</span><span class="token attr-value">configserver     #指定统一配置服务中心的服务唯一标识</span>
<span class="token attr-name">spring.cloud.config.label</span><span class="token punctuation">=</span><span class="token attr-value">master													#指定从仓库的那个分支拉取配置	</span>
<span class="token attr-name">spring.cloud.config.name</span><span class="token punctuation">=</span><span class="token attr-value">client														#指定拉取配置文件的名称</span>
<span class="token attr-name">spring.cloud.config.profile</span><span class="token punctuation">=</span><span class="token attr-value">dev														#指定拉取配置文件的环境</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>远程仓库创建配置文件
<span class="token operator">-</span> client<span class="token punctuation">.</span>properties										<span class="token punctuation">[</span>用来存放公共配置<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
	spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>configclient
	spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>consul<span class="token punctuation">.</span>host<span class="token operator">=</span>localhost
	spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>consul<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8500</span>

<span class="token operator">-</span> client<span class="token operator">-</span>dev<span class="token punctuation">.</span>properties  							<span class="token punctuation">[</span>用来存放研发相关配置<span class="token punctuation">]</span><span class="token punctuation">[</span>注意<span class="token operator">:</span>这里端口为例<span class="token punctuation">,</span>以后不同配置分别存放<span class="token punctuation">]</span>
	server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">9099</span>

<span class="token operator">-</span> client<span class="token operator">-</span>prod<span class="token punctuation">.</span>properties							<span class="token punctuation">[</span>用来存放生产相关配置<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
	server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">9098</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552418.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231552418.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722102322149"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>启动客户端服务进行远程配置拉取测试
<span class="token operator">-</span> 直接启动过程中发现无法启动直接报错<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553690.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553690.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722102851999">![image-20200722102901146](SpringCloud 微服务工具集v1.1.assets/image-20200722102901146.png)</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 报错原因
<span class="token operator">-</span> 项目中目前使用的是application<span class="token punctuation">.</span>properties启动项目<span class="token punctuation">,</span>使用这个配置文件在springboot项目启动过程中不会等待远程配置拉取<span class="token punctuation">,</span>直接根据配置文件中内容启动<span class="token punctuation">,</span>因此当需要注册中心<span class="token punctuation">,</span>服务端口等信息时<span class="token punctuation">,</span>远程配置还没有拉取到<span class="token punctuation">,</span>所以直接报错<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553818.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553818.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722103435260"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 解决方案
<span class="token operator">-</span> 应该在项目启动时先等待拉取远程配置<span class="token punctuation">,</span>拉取远程配置成功之后再根据远程配置信息启动即可<span class="token punctuation">,</span>为了完成上述要求springboot官方提供了一种解决方案<span class="token punctuation">,</span>就是在使用统一配置中心时应该将微服务的配置文件名修改为bootstrap<span class="token punctuation">.</span><span class="token punctuation">(</span>properties|yml<span class="token punctuation">)</span><span class="token punctuation">,</span>bootstrap<span class="token punctuation">.</span>properties作为配置启动项目时<span class="token punctuation">,</span>会优先拉取远程配置<span class="token punctuation">,</span>远程配置拉取成功之后根据远程配置启动当前应用。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553868.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553868.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722103823678"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 再次启动服务<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553717.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553717.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722103913142"></p>
<p>![image-20200722104031932](SpringCloud 微服务工具集v1.1.assets/image-20200722104031932.png)</p>
<hr>
<h3 id="手动配置刷新"><a href="#手动配置刷新" class="headerlink" title="手动配置刷新"></a>手动配置刷新</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 在生产环境中<span class="token punctuation">,</span>微服务可能非常多<span class="token punctuation">,</span>每次修改完远端配置之后<span class="token punctuation">,</span>不可能对所有服务进行重新启动<span class="token punctuation">,</span>这个时候需要让修改配置的服务能够刷新远端修改之后的配置<span class="token punctuation">,</span>从而不要每次重启服务才能生效<span class="token punctuation">,</span>进一步提高微服务系统的维护效率。在springcloud中也为我们提供了手动刷新配置和自动刷新配置两种策略<span class="token punctuation">,</span>这里我们先使用手动配置文件刷新。

# <span class="token number">2</span><span class="token punctuation">.</span>在config client端加入刷新暴露端点<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">management.endpoints.web.exposure.include</span><span class="token punctuation">=</span><span class="token attr-value">*          #开启所有web端点暴露</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553446.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553446.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722144351017"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>在需要刷新代码的类中加入刷新配置的注解<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;name&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test/test"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"当前加载配置文件信息为:[&#123;&#125;]"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553966.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553966.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722153537692"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>在远程配置中加入name并启动测试<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553564.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553564.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722153731602"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>启动之后直接访问<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553597.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553597.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722153806932"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>修改远程配置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553726.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553726.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722203225968"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">7</span><span class="token punctuation">.</span>修改之后在访问
<span class="token operator">-</span> 发现并没有自动刷新配置<span class="token operator">?</span>
<span class="token operator">-</span> 必须调用刷新配置接口才能刷新配置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553999.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553999.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722203317795"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">8</span><span class="token punctuation">.</span>手动调用刷新配置接口
<span class="token operator">-</span> curl <span class="token operator">-</span>X POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9099</span><span class="token operator">/</span>actuator<span class="token operator">/</span>refresh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553557.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553557.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722203417879"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">9</span><span class="token punctuation">.</span>在次访问发现配置已经成功刷新<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553546.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553546.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200722203452506"></p>
<hr>
<h2 id="12-Bus组件的使用"><a href="#12-Bus组件的使用" class="headerlink" title="12.Bus组件的使用"></a>12.Bus组件的使用</h2><h3 id="什么是Bus-AMQP-RibbitMQ、Kafka）"><a href="#什么是Bus-AMQP-RibbitMQ、Kafka）" class="headerlink" title="什么是Bus (AMQP RibbitMQ、Kafka）"></a>什么是Bus (AMQP RibbitMQ、Kafka）</h3><p>Spring Cloud Bus links nodes of a distributed system with a lightweight message broker. This can then be used to broadcast state changes (e.g. configuration changes) or other management instructions. AMQP and Kafka broker implementations are included with the project. Alternatively, any <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-stream">Spring Cloud Stream</a> binder found on the classpath will work out of the box as a transport.   –摘自官网</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>翻译
<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>spring<span class="token punctuation">.</span>io<span class="token operator">/</span>projects<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>bus
<span class="token operator">-</span> springcloudbus使用轻量级消息代理将分布式系统的节点连接起来。然后，可以使用它来广播状态更改（例如配置更改）或其他管理指令。AMQP和Kafka <span class="token function">broker</span><span class="token punctuation">(</span>中间件<span class="token punctuation">)</span>实现包含在项目中。或者，在类路径上找到的任何springcloudstream绑定器都可以作为传输使用。


<span class="token operator">-</span> 通俗定义<span class="token operator">:</span> bus称之为springcloud中消息总线<span class="token punctuation">,</span>主要用来在微服务系统中实现远端配置更新时通过广播形式通知所有客户端刷新配置信息<span class="token punctuation">,</span>避免手动重启服务的工作<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="实现配置刷新原理"><a href="#实现配置刷新原理" class="headerlink" title="实现配置刷新原理"></a>实现配置刷新原理</h3><p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553385.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553385.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723150335451"></p>
<h3 id="搭建RabbitMQ服务"><a href="#搭建RabbitMQ服务" class="headerlink" title="搭建RabbitMQ服务"></a>搭建RabbitMQ服务</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">0</span><span class="token punctuation">.</span>下载rabbitmq安装包 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span>可以直接使用docker安装更方便<span class="token punctuation">]</span>
<span class="token operator">-</span> 官方安装包下载<span class="token operator">:</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>com<span class="token operator">/</span>install<span class="token operator">-</span>rpm<span class="token punctuation">.</span>html#downloads
<span class="token punctuation">[</span>注意<span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span>这里安装包只能用于centos7<span class="token punctuation">.</span>x系统<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553802.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231553802.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20190925220343521"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">
# <span class="token number">1</span><span class="token punctuation">.</span>将rabbitmq安装包上传到linux系统中
	erlang<span class="token operator">-</span><span class="token number">22.0</span><span class="token punctuation">.</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>rpm
	rabbitmq<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">3.7</span><span class="token punctuation">.</span><span class="token number">18</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm

# <span class="token number">2</span><span class="token punctuation">.</span>安装Erlang依赖包
	rpm <span class="token operator">-</span>ivh erlang<span class="token operator">-</span><span class="token number">22.0</span><span class="token punctuation">.</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>rpm

# <span class="token number">3</span><span class="token punctuation">.</span>安装RabbitMQ安装包<span class="token punctuation">(</span>需要联网<span class="token punctuation">)</span>
	yum install <span class="token operator">-</span>y rabbitmq<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">3.7</span><span class="token punctuation">.</span><span class="token number">18</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
		注意<span class="token operator">:</span>默认安装完成后配置文件模板在<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>doc<span class="token operator">/</span>rabbitmq<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">3.7</span><span class="token punctuation">.</span><span class="token number">18</span><span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>config<span class="token punctuation">.</span>example目录中<span class="token punctuation">,</span>需要	
				将配置文件复制到<span class="token operator">/</span>etc<span class="token operator">/</span>rabbitmq<span class="token operator">/</span>目录中<span class="token punctuation">,</span>并修改名称为rabbitmq<span class="token punctuation">.</span>config
# <span class="token number">4</span><span class="token punctuation">.</span>复制配置文件
	cp <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>doc<span class="token operator">/</span>rabbitmq<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">3.7</span><span class="token punctuation">.</span><span class="token number">18</span><span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>config<span class="token punctuation">.</span>example <span class="token operator">/</span>etc<span class="token operator">/</span>rabbitmq<span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>config

# <span class="token number">5</span><span class="token punctuation">.</span>查看配置文件位置
	ls <span class="token operator">/</span>etc<span class="token operator">/</span>rabbitmq<span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>config

# <span class="token number">6</span><span class="token punctuation">.</span>修改配置文件<span class="token punctuation">(</span>参见下图<span class="token operator">:</span><span class="token punctuation">)</span>
	vim <span class="token operator">/</span>etc<span class="token operator">/</span>rabbitmq<span class="token operator">/</span>rabbitmq<span class="token punctuation">.</span>config <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554368.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554368.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20190925222230260"></p>
<p>将上图中配置文件中红色部分去掉<code>%%</code>,以及最后的<code>,</code>逗号 修改为下图:</p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554273.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554273.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20190925222329200"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">7</span><span class="token punctuation">.</span>执行如下命令<span class="token punctuation">,</span>启动rabbitmq中的插件管理
	rabbitmq<span class="token operator">-</span>plugins enable rabbitmq_management
	
	出现如下说明<span class="token operator">:</span>
		Enabling plugins on node <span class="token label symbol">rabbit@</span>localhost<span class="token operator">:</span>
    rabbitmq_management
    The following plugins have been configured<span class="token operator">:</span>
      rabbitmq_management
      rabbitmq_management_agent
      rabbitmq_web_dispatch
    Applying plugin configuration <span class="token keyword">to</span> <span class="token label symbol">rabbit@</span>localhost<span class="token operator">..</span><span class="token punctuation">.</span>
    The following plugins have been enabled<span class="token operator">:</span>
      rabbitmq_management
      rabbitmq_management_agent
      rabbitmq_web_dispatch

    <span class="token keyword">set</span> <span class="token number">3</span> plugins<span class="token punctuation">.</span>
    Offline change<span class="token punctuation">;</span> changes will take effect at broker restart<span class="token punctuation">.</span>

# <span class="token number">8</span><span class="token punctuation">.</span>启动RabbitMQ的服务
	systemctl start rabbitmq<span class="token operator">-</span>server
	systemctl restart rabbitmq<span class="token operator">-</span>server
	systemctl stop rabbitmq<span class="token operator">-</span>server
	

# <span class="token number">9</span><span class="token punctuation">.</span>查看服务状态<span class="token punctuation">(</span>见下图<span class="token operator">:</span><span class="token punctuation">)</span>
	systemctl status rabbitmq<span class="token operator">-</span>server
  ● rabbitmq<span class="token operator">-</span>server<span class="token punctuation">.</span>service <span class="token operator">-</span> RabbitMQ broker
     Loaded<span class="token operator">:</span> <span class="token function">loaded</span> <span class="token punctuation">(</span><span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>rabbitmq<span class="token operator">-</span>server<span class="token punctuation">.</span>service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset<span class="token operator">:</span> disabled<span class="token punctuation">)</span>
     Active<span class="token operator">:</span> <span class="token function">active</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since 三 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">22</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">35</span> CST<span class="token punctuation">;</span> 7s ago
   Main PID<span class="token operator">:</span> <span class="token function">2904</span> <span class="token punctuation">(</span>beam<span class="token punctuation">.</span>smp<span class="token punctuation">)</span>
     Status<span class="token operator">:</span> <span class="token string-literal singleline"><span class="token string">"Initialized"</span></span>
     CGroup<span class="token operator">:</span> <span class="token operator">/</span>system<span class="token punctuation">.</span>slice<span class="token operator">/</span>rabbitmq<span class="token operator">-</span>server<span class="token punctuation">.</span>service
             ├─<span class="token number">2904</span> <span class="token operator">/</span>usr<span class="token operator">/</span>lib64<span class="token operator">/</span>erlang<span class="token operator">/</span>erts<span class="token operator">-</span><span class="token number">10.4</span><span class="token punctuation">.</span><span class="token number">4</span><span class="token operator">/</span>bin<span class="token operator">/</span>beam<span class="token punctuation">.</span>smp <span class="token operator">-</span>W w <span class="token operator">-</span>A <span class="token number">64</span> <span class="token operator">-</span>MBas ageffcbf <span class="token operator">-</span>MHas ageffcbf <span class="token operator">-</span>
             MBlmbcs<span class="token operator">..</span><span class="token punctuation">.</span>
             ├─<span class="token number">3220</span> erl_child_setup <span class="token number">32768</span>
             ├─<span class="token number">3243</span> inet_gethost <span class="token number">4</span>
             └─<span class="token number">3244</span> inet_gethost <span class="token number">4</span>
      <span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span>
# <span class="token number">10</span><span class="token punctuation">.</span>启动出现如下错误<span class="token operator">:</span>
<span class="token operator">-</span> <span class="token number">4</span>月 <span class="token number">21</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">50</span> bogon systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> Starting RabbitMQ broker<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token operator">-</span> <span class="token number">4</span>月 <span class="token number">21</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">11</span> bogon rabbitmq<span class="token operator">-</span>server<span class="token punctuation">[</span><span class="token number">1772</span><span class="token punctuation">]</span><span class="token operator">:</span> ERROR<span class="token operator">:</span> epmd error <span class="token keyword">for</span> host bogon<span class="token operator">:</span> <span class="token function">address</span> <span class="token punctuation">(</span>cannot connect <span class="token keyword">to</span> host<span class="token operator">/</span>port<span class="token punctuation">)</span>
<span class="token operator">-</span> <span class="token number">4</span>月 <span class="token number">21</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">11</span> bogon systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> rabbitmq<span class="token operator">-</span>server<span class="token punctuation">.</span>service<span class="token operator">:</span> main process exited<span class="token punctuation">,</span> code<span class="token operator">=</span>exited<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span>FAILURE
 `解决方案`<span class="token operator">:</span> 
   <span class="token number">1</span><span class="token punctuation">.</span> 修改主机名   vim <span class="token operator">/</span>etc<span class="token operator">/</span>hostname   修改为自己注解名  rabbimq   <span class="token number">2</span><span class="token punctuation">.</span>修改完必须重启
   <span class="token number">3</span><span class="token punctuation">.</span> vim <span class="token operator">/</span>etc<span class="token operator">/</span>hosts   在文件中添加<span class="token operator">:</span>  <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span>   自己主机名<span class="token punctuation">(</span>rabbitmq<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554239.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554239.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20190925222743776"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">10</span><span class="token punctuation">.</span>关闭防火墙服务
	systemctl disable firewalld
    Removed symlink <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target<span class="token punctuation">.</span>wants<span class="token operator">/</span>firewalld<span class="token punctuation">.</span>service<span class="token punctuation">.</span>
    Removed symlink <span class="token operator">/</span>etc<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>dbus<span class="token operator">-</span>org<span class="token punctuation">.</span>fedoraproject<span class="token punctuation">.</span>FirewallD1<span class="token punctuation">.</span>service<span class="token punctuation">.</span>
	systemctl stop firewalld   

# <span class="token number">11</span><span class="token punctuation">.</span>访问web管理界面
	http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.15</span><span class="token punctuation">.</span><span class="token number">0.8</span><span class="token operator">:</span><span class="token number">15672</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554595.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554595.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20190926194738708"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">12</span><span class="token punctuation">.</span>登录管理界面
	username<span class="token operator">:</span>  guest
	password<span class="token operator">:</span>  guest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554958.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554958.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20190926194954822"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">13</span><span class="token punctuation">.</span>MQ服务搭建成功<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="实现自动配置刷新"><a href="#实现自动配置刷新" class="headerlink" title="实现自动配置刷新"></a>实现自动配置刷新</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>在所有项目中引入bus依赖<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--引入bus依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554550.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554550.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723104333906"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>配置统一配置中心连接到mq<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost											#连接主机</span>
<span class="token attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672														#连接mq端口</span>
<span class="token attr-name">spring.rabbitmq.username</span><span class="token punctuation">=</span><span class="token attr-value">user												#连接mq用户名</span>
<span class="token attr-name">spring.rabbitmq.password</span><span class="token punctuation">=</span><span class="token attr-value">password										#连接mq密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">3</span><span class="token punctuation">.</span>远端配置中加入连接mq配置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554862.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554862.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723105645915"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">4</span><span class="token punctuation">.</span>启动统一配置中心服务
<span class="token operator">-</span> 正常启动<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554969.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554969.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723111220198"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">5</span><span class="token punctuation">.</span>启动客户端服务
<span class="token operator">-</span> 加入bus组件之后客户端启动报错
<span class="token operator">-</span> 原因springcloud中默认链接不到远程服务器不会报错<span class="token punctuation">,</span>但是在使用bus消息总线时必须开启连接远程服务失败报错<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554633.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554633.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723111312496"></p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.cloud.config.fail-fast</span><span class="token punctuation">=</span><span class="token attr-value">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554633.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554633.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723111754187"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">6</span><span class="token punctuation">.</span>修改远程配置后在配置中心服务通过执行post接口刷新配置
<span class="token operator">-</span> curl <span class="token operator">-</span>X POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>actuator<span class="token operator">/</span>bus<span class="token operator">-</span>refresh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554961.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554961.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723112316476"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">7</span><span class="token punctuation">.</span>通过上述配置就实现了配置统一刷新<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="指定服务刷新配置"><a href="#指定服务刷新配置" class="headerlink" title="指定服务刷新配置"></a>指定服务刷新配置</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>说明
<span class="token operator">-</span> 默认情况下使用curl <span class="token operator">-</span>X POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>actuator<span class="token operator">/</span>bus<span class="token operator">-</span>refresh这种方式刷新配置是全部广播形式<span class="token punctuation">,</span>也就是所有的微服务都能接收到刷新配置通知<span class="token punctuation">,</span>但有时我们修改的仅仅是某个服务的配置<span class="token punctuation">,</span>这个时候对于其他服务的通知是多余的<span class="token punctuation">,</span>因此就需要指定服务进行通知

# <span class="token number">2</span><span class="token punctuation">.</span>指定服务刷新配置实现
<span class="token operator">-</span> 指定端口刷新某个具体服务<span class="token operator">:</span> curl <span class="token operator">-</span>X POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>actuator<span class="token operator">/</span>bus<span class="token operator">-</span>refresh<span class="token operator">/</span>configclient<span class="token operator">:</span><span class="token number">9090</span>
<span class="token operator">-</span> 指定服务id刷新服务集群节点<span class="token operator">:</span> curl <span class="token operator">-</span>X POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7878</span><span class="token operator">/</span>actuator<span class="token operator">/</span>bus<span class="token operator">-</span>refresh<span class="token operator">/</span>configclient
 	<span class="token punctuation">[</span>注意<span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span>configclient代表刷新服务的唯一标识<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="集成webhook实现自动刷新"><a href="#集成webhook实现自动刷新" class="headerlink" title="集成webhook实现自动刷新"></a>集成webhook实现自动刷新</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">1</span><span class="token punctuation">.</span>配置webhooks
<span class="token operator">-</span> 说明<span class="token operator">:</span> git仓库提供一种特有机制<span class="token operator">:</span> 这种机制就是一个监听机制    监听就是仓库提交事件 <span class="token operator">..</span><span class="token punctuation">.</span>  触发对应事件执行
<span class="token operator">-</span> javascript<span class="token operator">:</span> 事件  事件源 html标签  事件<span class="token operator">:</span> 触发特定动作click  <span class="token operator">..</span><span class="token punctuation">.</span>  事件处理程序<span class="token operator">:</span>函数
<span class="token operator">-</span> 添加webhooks
<span class="token operator">-</span> 在webhooks中添加刷新配置接口

<span class="token operator">-</span> 内网穿透的网站<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>natapp<span class="token punctuation">.</span>cn<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554954.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554954.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723120419412"></p>
<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554799.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554799.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723120947229"></p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># <span class="token number">2</span><span class="token punctuation">.</span>解决<span class="token number">400</span>错误问题
<span class="token operator">-</span> 在配置中心服务端加入过滤器进行解决<span class="token punctuation">(</span>springcloud中一个坑<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UrlFilter</span>  <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
 
    <span class="token punctuation">&#125;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span>request<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> httpServletResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span>response<span class="token punctuation">;</span>
 
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">//只过滤/actuator/bus-refresh请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"/bus-refresh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 
        <span class="token comment">//获取原始的body</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token function">readAsChars</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"original body:   "</span><span class="token operator">+</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">//使用HttpServletRequest包装原始请求达到修改post请求中body内容的目的</span>
        <span class="token class-name">CustometRequestWrapper</span> requestWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustometRequestWrapper</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>requestWrapper<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token punctuation">&#125;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CustometRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">CustometRequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ServletInputStream</span> <span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServletInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> byteArrayInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token boolean">true</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
 
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
 
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReadListener</span><span class="token punctuation">(</span><span class="token class-name">ReadListener</span> readListener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 
                <span class="token punctuation">&#125;</span>
 
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> byteArrayInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readAsChars</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
 
        <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            br <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> str<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> br<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">&#123;</span>
                    br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554641.png" class="lazyload placeholder" data-srcset="https://gy-blog.oss-cn-beijing.aliyuncs.com/pic/202210231554641.png" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="image-20200723121203864"></p>
<hr>
<h2 id="13-SpringCloud-微服务工具集总结"><a href="#13-SpringCloud-微服务工具集总结" class="headerlink" title="13. SpringCloud  微服务工具集总结"></a>13. SpringCloud  微服务工具集总结</h2><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"># 服务间通信方式<span class="token operator">:</span> RPC  、 Http 协议 <span class="token punctuation">(</span>SpringCloud中<span class="token punctuation">)</span>

# <span class="token number">1</span><span class="token punctuation">.</span>服务注册中心组件<span class="token operator">:</span>  Eureka  、 Consul

# <span class="token number">2</span><span class="token punctuation">.</span>服务间通信实现 <span class="token operator">:</span>  
	 a<span class="token punctuation">.</span><span class="token function">RestTemplate</span><span class="token punctuation">(</span>HttpClient对象<span class="token punctuation">)</span> <span class="token operator">+</span> Ribbon组件<span class="token punctuation">(</span>springcloud<span class="token punctuation">)</span>
	 b<span class="token punctuation">.</span><span class="token function">openfegin</span><span class="token punctuation">(</span>伪httpclient客户端组件 底层默认集成Ribbon<span class="token punctuation">)</span>  推荐

# <span class="token number">3</span><span class="token punctuation">.</span>微服务保护组件<span class="token operator">:</span> <span class="token function">Hystrix</span> <span class="token punctuation">(</span>防止服务雪崩现象<span class="token punctuation">)</span>  Hystrix DashBoard 组件  维护状态

# <span class="token number">4</span><span class="token punctuation">.</span>微服务网关组件<span class="token operator">:</span> Zuul1<span class="token punctuation">.</span>x  Zuul2<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span>netflix组件<span class="token punctuation">)</span>、<span class="token function">Gateway</span><span class="token punctuation">(</span>Spring 组件<span class="token punctuation">)</span>
	网关： 路由转发  <span class="token operator">+</span>  过滤器（前置predicate   后置filter）

# <span class="token number">5</span><span class="token punctuation">.</span>统一配置中心组件<span class="token operator">:</span>  <span class="token function">Config</span> <span class="token punctuation">(</span>netflix<span class="token punctuation">)</span>
	作用<span class="token operator">:</span> 用来将微服务中所有配置进行远程git仓库统一管理

# <span class="token number">6</span><span class="token punctuation">.</span>消息总线<span class="token operator">:</span>         Bus 
	作用<span class="token operator">:</span> 用来通过消息中间件将所有微服务连接到一起<span class="token punctuation">,</span>利用广播模型实现配置自动刷新机制<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="">
              微服务
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>作者:  </strong>高小天</a>
    </li>
    <li class="post-copyright-link">
    <strong>文章链接:  </strong>
    <a href="/2020/08/26/SpringCloud 微服务工具集v1.1/" target="_blank" title="Spring Cloud">https://gaoyang.world/2020/08/26/SpringCloud 微服务工具集v1.1/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明:   </strong>
      本网站所有文章除特别声明外,均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      许可协议。转载请注明出处!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="/medias/8.jpg" class="lazyload placeholder" data-srcset="/medias/8.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="">
    </div>
    <a href="/2020/08/26/shiro/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> 上一篇:
        <div class="title-text">Shiro</div>
      </div>
      
      <!-- <div class="content">
        [TOC]
课程知识点1、权限系统的整体概念
2、shiro权限框架的核心组件
3、springboot下shiro的使
      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="/medias/13.jpg" class="lazyload placeholder" data-srcset="/medias/13.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" src="" alt="">
    </div>
    <a href="/2020/08/25/Dubbo/" class="post-nav-link">
      <div class="title">
        下一篇: <i class="fas fa-angle-right"></i>
        <div class="title-text">Dubbo</div>
      </div>
      <!-- <div class="content">
        1-今日内容 分布式系统中的相关概念
dubbo 概述
dubbo快速入门
dubbo的高级特性
2-相关概念2.1-互
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    
      <div id="appDonate" class="post-donate">
  <div id="donate_board" class="donate_bar center" ref="donate">
    <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏" @click="showDialogDrawer()"></a>
  </div>
  <transition name="fade">
    <div 
      class="donate-box-mask"
      v-cloak 
      v-show="visible"
      @click="cancelDialogDrawer()"
    >
    </div>
  </transition>
  <transition name="bounce">
    <div class="donate-box" v-cloak v-show="visible">
      <div class="donate-box_close">
        <i class="fas fa-times" aria-hidden="true" @click="cancelDialogDrawer" pointer></i>
      </div>
      <div class="donate-box_title">
        <h4>
          你的赏识是我前进的动力
        </h4>
      </div>
      <div class="donate-box_tab">
        <div class="Alipay" pointer :class="{'active': tabActive === 'Alipay'}" @click="changeTabActive('Alipay')">
          支付宝
        </div>
        <div class="WeChatpay" pointer :class="{'active': tabActive === 'WeChatpay'}" @click="changeTabActive('WeChatpay')">
          微信
        </div>
      </div>
      <div class="donate-box_img">
        <div class="AlipayImg" v-show="tabActive === 'Alipay'">
          <img src="/medias/zfb.jpg" class="lazyload placeholder" data-srcset="/medias/zfb.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="支付宝打赏" />
        </div> 
        <div class="WeChatpayImg" v-show="tabActive === 'WeChatpay'">
          <img src="/medias/wx.jpg" class="lazyload placeholder" data-srcset="/medias/wx.jpg" srcset="https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg" alt="微信打赏" />
        </div>
      </div>
    </div>
  </transition>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDonate',
    data: {
      visible: false,
      tabActive: 'Alipay',
      top: 0,
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        // function getScroll() {
        //   return {
        //     left: window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0,
        //     top: window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0
        //   };
        // }
        this.top = $(document).scrollTop() // or getScroll().top
        // console.log('aa', $('.main-content'));
        body.style.cssText = 'overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
      changeTabActive(name) {
        this.tabActive = name;
      }
    },
    created() {}
  })
</script>
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>

<!-- comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <!-- 文章详情页右侧目录 -->


<script>
  function closeToc(init) {
    $(".toc-aside").css({'width': 0, 'padding': 0, 'transition': init ?  'noe' : 'width 0.3s' });
    $(".toc-content").css({'width': 0});
    $(".toc-aside-title span, .toc-aside-title i").css({'display': 'none'});
    $(".main-content").css({'width': '75%', 'margin': '10px auto'});
  };
  function openToc() {
    $(".main-content").css({'width': '65%', 'margin-right': '10px', 'margin-left': 'calc(35% - 350px)'});
    $(".toc-aside").css({'width': '300px', 'padding': '0 10px', 'transition': 'width 0.3s'});
    $(".toc-content").css({'width': '300px'});
    $(".toc-aside-title span, .toc-aside-title i").css({'display': 'inline-block'});
  }
  function openBtnClickFn () {
    let openOrCloseBtn = $('.toc-aside .toc-aside-title .toc-open-close');
    let open = eval('false' || 'true');
    openOrCloseBtn.click(function() {
      if (open) {
        closeToc();
        open = false;
      } else {
        openToc();
        open = true;
      }
    });
  };
  openBtnClickFn();
  initCloseTocWidth(true);

  function initCloseTocWidth(init) {
    if (window.innerWidth >= 992) {
      let isClose = true;
      isClose && closeToc(init)
    }
  }

  document.addEventListener('pjax:complete', function () {
    $(".toc-aside").css({'transition': 'no'});
  })
  document.addEventListener('pjax:complete', function () {
    openBtnClickFn();
  })
  
</script>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '180000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || '';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




  <script>
  function loadMermaid() {
    if (document.getElementsByClassName('mermaid').length) {
      if (window.mermaidJsLoad) mermaid.init()
      else {
        loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
          window.mermaidJsLoad = true
          mermaid.initialize({
            theme: 'default',
          })
          if ('true') {
            mermaid.init();
          }
        })
      }
    }
  };
  document.addEventListener("DOMContentLoaded", function () {
    loadMermaid();
  })

  document.addEventListener('pjax:complete', function () {
    loadMermaid();
  })
  
</script>


      </main>
    </div>

    <!-- 页脚 -->
    
  
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2019 - 2020  </p>

          </div>
        
      
        
          
            <!-- 不蒜子统计 -->
            <!-- 不蒜子统计 -->
<span id="busuanzi_container_site_pv">
      <i class="fas fa-eye" aria-hidden="true"></i>本站总访问量：<span id="busuanzi_value_site_pv"></span> 次
</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_uv" style='display:none'>
      <i class="fas fa-users" aria-hidden="true"></i>本站访客数：<span id="busuanzi_value_site_uv"></span> 人
</span>

          
        
      
        
          <div class="footer-custom">
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fas fa-moon" aria-hidden="true"></i>
    <!-- <span>关灯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-moon" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    
      <link rel="stylesheet" href="/js/aplayer/APlayer@1.10.1.min.css">
<style>
.aplayer .aplayer-lrc p {
  
  font-size: 12px;
  font-weight: 700;
  line-height: 16px !important;
}

.aplayer .aplayer-lrc p.aplayer-lrc-current {
  
  font-size: 15px;
  color: #42b983;
}


.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
  left: -66px !important;
}

.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
  left: 0px !important;
}


</style>
<meting-js  
  class=""
  server="tencent"
  type="playlist"
  id="8062553743"
  fixed='true'
  autoplay='false'
  theme='#42b983'
  loop='all'
  order='random'
  preload='auto'
  volume='0.7'
  list-folded='true'
>
</meting-js>

<!-- <style>
  #aplayer {
    position: fixed;
    left: 0;
    bottom: 300px;
  }
</style> -->
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    

    <!-- 图片放大 -->
    
      <script src="/js/fancybox/jquery.fancybox.min.js"></script>
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <!-- 背景彩带 -->
    
      <script type="text/javascript" size="100" alpha='0.4' zIndex="-1" src="/js/ribbon.min.js"></script>
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script>

<script>
  var headerEl = 'h2, h3, h4',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -80,
    headingsOffset: -($(window).height() * 0.4 - 45),
    positionFixedSelector: '.toc-main',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 100) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('toc-aside')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  }
</style> 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const headerMenuTransparent = true;
    if (!headerMenuTransparent) { return; }
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.css">
  <script src="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = '复制';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制，请遵守相关授权协议。",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
    <script type="text/javascript">
  var utteranceCommon = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceCommon.Theme = 'github-dark';
    } else {
      utteranceCommon.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceCommon.Theme)
      utterances.setAttribute('repo', '')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceCommon.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
  


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

  
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 999; pointer-events: none;" ></canvas>
    <script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script src="/js/cursor/explosion.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-pjax></script>


    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>